<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<title>
		1255 Burgomaster
	</title>
	<style type="text/css">
		/*canvas*/
		.canvas {
			left:0px;
			top:-6px;
			position:relative;
		}
		/*background*/
		.background {
			position:absolute;
			left:0px;
			top:0px;
			z-index:-1;
		}
		/*wall rear*/
		.over1 {
			position:absolute;
			left:0px;
			top:0px;
			z-index:1;
		}
		/*buildings*/
		.over2 {
			position:absolute;
			left:0px;
			top:0px;
			z-index:2;
		}
		/*wall front*/
		.over3 {
			position:absolute;
			left:0px;
			top:0px;
			z-index:3;
		}
		/*fire*/
		.fire {
			position:absolute;
			left:0px;
			top:0px;
			z-index:4;
		}
		.interface {
			position:absolute;
			left:0px;
			top:0px;
			z-index:99;
		}
		.resources{
			position: relative;
			left:0px;
		}
		/*
		#defence, #homes, #treasury {
			width: 180px;
		}
		#buttonBldGallows, #buttonBldFountain, #buttonBldStash {
			width: 180px;
		}*/
		#console_n_chat, #lblAutocampaignJournal {
			/*resize: none;*/
			overflow: auto;
		}
		/* Style the tab */
		div.tab {
			overflow: hidden;
			border: 1px solid #ccc;

			width: 800px;
			background-color: #f1f1f1;
		}
		div {
			color: #2f3236;
		}
		/* Style the buttons inside the tab */
		div.tab button {
			background-color: inherit;
			float: left;
			border: none;
			outline: none;
			cursor: pointer;
			padding: 14px 16px;
			transition: 0.3s;
			font-size: 17px;
		}
		td.building {
			width:180px;
		}
		button.building {
			width:180px;
		}
		/* Change background color of buttons on hover */
		div.tab button:hover {
			background-color: #ddd;
		}

		/* Create an active/current tablink class */
		div.tab button.active {
			background-color: #ccc;
		}

		/* Style the tab content */
		.tabcontent {
			display: none;
			padding: 6px 0px;
			border: 1px solid #ccc;
			border-top: none;
			height: 470px;
			width: 800px;/*800-12*2*/
		}
		/* Style the close button */
		.topright {
			float: right;
			cursor: pointer;
			font-size: 20px;
		}
		.topright:hover {color: red;}
		#lblAboutGame {
			width: 795px;
			height: 475px;
			border: thin solid black;
			overflow:scroll;
			/*
            overflow-x: hidden;
            overflow-y: scroll;
            */
		}
		#htmlGame {
			margin: auto;
		}
		#theBuildingDiv {
			width: 795px;
			height: 415px;
			border: thin solid black;
			overflow:scroll;
			/*
            overflow-x: hidden;
            overflow-y: scroll;
            */
		}
	</style>
	<script id="chatBroEmbedCode">
		/* Chatbro Widget Embed Code Start */
		function ChatbroLoader(chats,async){async=!1!==async;var params={embedChatsParameters:chats instanceof Array?chats:[chats],lang:navigator.language||navigator.userLanguage,needLoadCode:'undefined'==typeof Chatbro,embedParamsVersion:localStorage.embedParamsVersion,chatbroScriptVersion:localStorage.chatbroScriptVersion},xhr=new XMLHttpRequest;xhr.withCredentials=!0,xhr.onload=function(){eval(xhr.responseText)},xhr.onerror=function(){console.error('Chatbro loading error')},xhr.open('GET','//www.chatbro.com/embed.js?'+btoa(unescape(encodeURIComponent(JSON.stringify(params)))),async),xhr.send()}
		/* Chatbro Widget Embed Code End */
		ChatbroLoader({encodedChatId: '1Leg'});
	</script>
</head>
<body>
<div id="htmlGame">
		<script>
			var url = window.location.pathname;
			var filename = url.substring(url.lastIndexOf('/')+1);
			if (filename == ""|| filename == "index.html" || filename =="index.htm" || filename =="index.php" || filename == "main2.html" || filename =="main.htm") {
				res_mod = "b";
			}
			else {
				res_mod = "b";
			}
			//alert(res_mod);
			/*
			function reload_res(this) {
			this.src=str.replace(\"_a\", res_mod);
			alert(this.src);
			}
			*/
		</script>
		<div class="tab">
			<button class="tablinks" onclick="openTab(event, 'Main')" id="tabCity">Main</button>
			<button class="tablinks" onclick="openTab(event, 'Explore')" id="tabExplore" style="display:none">Explore</button>
			<button class="tablinks" onclick="openTab(event, 'Building')" id="tabBuilding">Building</button>
			<button class="tablinks" onclick="openTab(event, 'Garrison')" id="tabGarrison">Garrison</button>
			<button class="tablinks" onclick="openTab(event, 'Settings')" id="tabSettings">Settings</button>
			<button class="tablinks" onclick="openTab(event, 'About')" id="tabAbout">How To Play</button>
			<button class="tablinks" onclick="openTab(event, 'Discord')" id="tabDiscord">Discord</button>
			<div id="dcounter">30</div>
			<!--<a href="https://www.patreon.com/bePatron?u=7838459" target="_blank"><img src="resources/patreon.png" style="padding: 6px 0px"></a>-->
		</div>
		<div id="Main" class="tabcontent">
			<canvas width="800" height="480" id="canvas" class="canvas" style="z-index:1"></canvas>
			<br>
			<p id="resources">
				<span id="gold" class="interface" onclick="checkGold()" style="position:absolute; top:100px; left:60px">0</span>
				<br>
				<br>
				<span id="pop"  class="interface" onclick="checkPop()"  style="position:absolute; top:140px; left:60px">2</span>
				<br>
			</p>
			<p id="events_graphics" style="z-index: 8">

			</p>
			<!--<img src="resources/fire_a.gif" id="fire_graphics" onclick="putOutFire()" style="position:absolute; top:170px; left:0px; z-index=98; display:none">-->
			<button id="saveGameButton"   onclick="saveGame()" class="interface" style="top:250px; left: 20px">Save game</button>
			<button id="loadGameButton"   onclick="loadGame()" class="interface" style="top:310px; left: 20px; visibility:hidden">Load game</button>
			<button id="buttonPutOutFire"   onclick="game.putOutFire()" class="interface" style="top:370px; left: 20px; display:none">Put out fire</button>
			<button id="buttonDeathPenalty"   onclick="game.deathPenalty()" class="interface" style="top:460px; left: 20px; display:none">Execute smb</button>
			<button id="buttonDebug"   onclick="ym(47225574, 'reachGoal', 'min5'); return true;" class="interface" style="top:190px; left: 20px; display:none">X</button>
			<!--
			<iframe id="constructionWindow" src="construction.html" class="interface" style="left:600px" width="1" height="1"></iframe>
			<button id="constructionButton" onclick="maximizew('construction')" class="interface" style="top:260px">Open construction menu</button>
			-->
		</div>
		<div id="Explore" class="tabcontent">
			<canvas width="800" height="480" id="canvasMap" class="canvas" style="z-index:1"></canvas>
			<p style="position:absolute; top:60px; left: 20px">
			GLOBALMAP
			</p>
		</div>
		<div id="Settings" class="tabcontent">
			<!--<span onclick="this.parentElement.style.display='none'" class="topright">x</span>-->
			<h3><div id="labelSettings">Settings</div></h3>
			<!-- TODO make checkboxes with chat system messages -->
			<!--<p>Alert / MSG to chat</p>-->
			<table>
			<tr>
				<!-- TODO make a message about turning on / off autosaves for color disabled people -->
				<td><div id="labelAutosave">Autosave</div><img id="autosaveImg" onclick="changeAutosave()" src="resources/button_red.png"></td>
				<td><button id="buttonExportGame" onclick="exportGame()" >Export Game</button></td>
				<td><button id="buttonImportGame" onclick="importGame()" >Import Game</button></td>
			</tr>
			</table>
			<input id="savestring" name="savestring" value="" style="width:600px">
			<div style="position: absolute; top: 90px; left:500px">
			<select id="selectLng" size="1" onchange="reloadLang()">
				<option id="optionLngEn" selected value="en-US">English</option>
				<option id="optionLngRu"          value="ru-RU">Русский</option>
				<option id="optionLngGe"          value="de-DE">Deutsch</option>
				<option id="optionLngEo"          value="eo">Esperanto</option>
				<option id="optionLngFr"          value="fr-FR">français</option>
			</select>
			</div>
			<br>
			<button id="btnColorMode" onclick="changeColorMode()">ChangeColorMode</button>
			<textarea id="patchnotes" class="interface" value="" style="width:700px; height:300px; top:230px; left:40px"></textarea>
		</div>
		<div id="Garrison" class="tabcontent">
			<!--<span onclick="this.parentElement.style.display='none'" class="topright">x</span>-->
			<h3><div id="labelGarrison">Garrison</div></h3>
			<div id="divtreasuryGuard">
			<table border="1">
				<tr>
					<td>
						<div align="center">
							<img src="resources/knight6.png">
						</div>
					</td>
				</tr>
				<tr>
					<td>
						<button id="buttonFireGuard" onclick="game.fireTreasuryGuard()" style="width:80px">Fire</button>
						<span id="treasuryGuard">0</span>
						<button id="buttonHireGuard" onclick="game.hireTreasuryGuard()" style="width:80px">Hire</button>
						<!--<button id="fireGuard" onclick="fireTreasuryGuard()" class="interface" style="top:170px; left:20px; width:80px">Fire</button>
						<span id="treasuryGuard" class="interface" style="position:absolute; top:170px; left:120px">0</span>
						<button id="hireGuard" onclick="hireTreasuryGuard()" class="interface" style="top:170px; left:180px;-->
					</td>
				</tr>
			</table>
			</div>
		</div>
		<div id="Building" class="tabcontent">
			<!--<span onclick="this.parentElement.style.display='none'" class="topright">x</span>-->
			<h3><div id="labelBuilding">Building</div></h3>
			<div id="theBuildingDiv">
				<table>
					<tr>
						<td>
							<table border="1">
								<tr>
									<td class="building">
										<div align="center">
											<img id="defencies_img" src="resources/wallsf_as2.png" onmouseover="game.help(this)" onclick="game.help(this)">
										</div>
									</td>
									<td class="building">
										<div align="center">
											<img id="home_img" src="resources/home_as.png" onmouseover="game.help(this)" onclick="game.help(this)">
										</div>
									</td>
									<td class="building">
										<div align="center">
											<img id="treasury_img" src="resources/treasury_as.png" onmouseover="game.help(this)" onclick="game.help(this)">
										</div>
									</td>
								</tr>
								<tr>
									<td class="building">
										<button id="defence" onclick="game.Build('Wall')" class="building">Build walls</button>
									</td>
									<td class="building">
										<button id="homes" onclick="game.Build('Home')" class="building">Build home</button>
									</td>
									<td class="building">
										<button id="treasury" onclick="game.Build('Treasury')" class="building">Build treasury</button>
									</td>
								</tr>
								<tr>
									<td class="building">
										<div align="center">
											<img id="gallows_img" src="resources/gallows.png" onmouseover="game.help(this)" onclick="game.help(this)">
										</div>
									</td>
									<td class="building">
										<div align="center">
											<img id="fountain_img" src="resources/fountain.png" onmouseover="game.help(this)" onclick="game.help(this)">
										</div>
									</td>
									<td class="building">
										<div align="center">
											<img id="moneystash_img" src="resources/trapdoor.png" onmouseover="game.help(this)" onclick="game.help(this)">
										</div>
									</td>
								</tr>
								<tr>
									<td class="building">
										<button id="buttonBldGallows" onclick="game.buildGallowsOrFountain('Gallows')" class="building">Build gallows</button>
									</td>
									<td class="building">
										<button id="buttonBldFountain" onclick="game.buildGallowsOrFountain('Fountain')" class="building">Build fountain</button>
									</td>
									<td class="building">
										<button id="buttonBldStash" onclick="game.Build('Stash')" class="building">Build stash</button>
									</td>
								</tr>
								<tr>
									<td class="building">
										<div align="center">
											<img id="inn_img" src="resources/inn.png" onmouseover="game.help(this)" onclick="game.help(this)">
										</div>
									</td>
									<td class="building">
										<div align="center">
											<img id="stable_img" src="resources/stable.png" onmouseover="game.help(this)" onclick="game.help(this)">
										</div>
									</td>
									<td class="building">
										<div align="center">

										</div>
									</td>
								</tr>
								<tr>
									<td class="building">
										<button id="buttonBldInn" onclick="game.Build('Inn')" class="building">Build Inn</button>
									</td>
									<td class="building">
										<button id="buttonBldStable" onclick="game.Build('Stable')" class="building">Build Stable</button>
									</td>
									<td class="building">

									</td>
								</tr>
							</table>
						</td>
						<td>
							<div id="lblBuildHelp">

							</div>
						</td>
					</tr>
				</table>
			</div>
		</div>
		<div id="About" class="tabcontent">
			<div id="lblAboutGame">
			<h1>1255 Burgomaster</h1><br>
			<h2>How to play</h2>
			</div>
		</div>
		<div id="tabPopulation" class="tabcontent">
			<!-- TODO make style!!! -->
			<div id="lblTabPop">Population history tab</div>
			<br>
			<table border="1">
			<tbody>
			<tr id="popStatK">
			</tr>
			<tr id="popStatV">
			</tr>
			</tbody>
			</table>
			<br>
			<button id="btnPopAtStart"  onclick="popAtStart()" style="width:80px"><<</button>
			<button id="btnPopPrev"     onclick="popPrev()" style="width:80px"><</button>
			<button id="btnPopNext"     onclick="popNext()" style="width:80px">></button>
			<button id="btnPopAtEnd"    onclick="popAtEnd()" style="width:80px">>></button>
			<br>
			<br>
			<div id="lblCurrentPopLimit"></div>
		</div>
		<div id="tabGold" class="tabcontent">
			<!-- TODO make style!!! -->
			<div id="lblTabGold">Gold history tab</div>
			<br>
			<table border="1">
			<tbody>
			<tr id="goldStatK">
			</tr>
			<tr id="goldStatV">
			</tr>
			</tbody>
			</table>
			<br>
			<button id="btnGoldAtStart"  onclick="goldAtStart()" style="width:80px"><<</button>
			<button id="btnGoldPrev"     onclick="goldPrev()" style="width:80px"><</button>
			<button id="btnGoldNext"     onclick="goldNext()" style="width:80px">></button>
			<button id="btnGoldAtEnd"    onclick="goldAtEnd()" style="width:80px">>></button>
			<br>
			<br>
			<div id="lblCurrentGoldLimit"></div>
		</div>
		<div id="tabInn" class="tabcontent">
			<div id="lblTabInn">Welcome to Inn!</div>
			<br>
			<br>
			<select id="selectHeroClass" size="1" onchange="reloadHeroClassImg()">
				<option id="optionKnight" selected value="0">Knight</option>
				<option id="optionMonk"            value="1"  >Monk</option>
				<!--TODO <option id="optionInquisitor"          value="inquisitor">Inquisitor</option> -->
			</select>
			<br>
			<br>
			<button id="btnHireHero"    onclick="game.heroHire()" style="width:160px">Hire hero %arg1 level</button>
			<br>
			<br>
			<div id="heroStats">

			</div>
			<br>
			<button id="btnAutocampaign"    onclick="game.autocampaign()" style="width:160px; visibility: hidden">Launch autocampaign!</button>
			<button id="btnAutocampaignJournal"    onclick="openTab(null, 'tabAutocampaignJournal')" style="width:160px; visibility: hidden">Open journal</button>
			<button id="btnDismissHero"    onclick="game.heroDismiss()" style="width:160px">Dismiss hero</button>
			<br>
			<br>
			<button id="btnLeaveCity"    onclick="game.leaveCity()" style="width:160px; visibility: hidden">Go to exploring!</button>
		</div>
		<div id="tabAutocampaignJournal" class="tabcontent">
			<div id="lblAutocampaignJournal" class="interface" value="" style="width:800px; height:470px; top: 60px; left: 10px"></div>
		</div>
		<div id="tabTroopsHiring" class="tabcontent">
			Hiring troops
			<table border="1px">
				<tr>
					<td>
					placeholder
					</td>
					<td>
						images
					</td>
					<td>
						images
					</td>
					<td>
						images
					</td>
				</tr>
				<tr>
					<td>
						placeholder
					</td>
					<td>
						<button id="btnHireSergeant" onclick="game.hireTroopsSergeant()" style="width:80px">Hire sergeant</button>
					</td>
					<td>
						<button id="btnHireTurkopol" onclick="game.hireTroopsTurkopol()" style="width:80px">Hire turkopol</button>
					</td>
					<td>
						<button id="btnHireKnight" onclick="game.hireTroopsKnight()" style="width:80px">Hire knight</button>
					</td>
				</tr>
				<tr>
					<td>
						castellan
					</td>
					<td>
						sergeants: <div id="lblGarnisonSergeants" style="display: inline">0</div><button id="btnMoveSergeantToHero" onclick="game.moveSergeantsToHero()">↓</button>
					</td>
					<td>
						turkopols: <div id="lblGarnisonTurkopols" style="display: inline">0</div><button id="btnMoveTurkopolToHero" onclick="game.moveTurkopolsToHero()">↓</button>
					</td>
					<td>
						knights: <div id="lblGarnisonKnights" style="display: inline">0</div><button id="btnMoveKnightToHero" onclick="game.moveKnightsToHero()">↓</button>
					</td>
				</tr>
				<tr id="trHeroHiringTroops" style="visibility: collapse">
					<td>
						hero
					</td>
					<td>
						sergeants: <div id="lblHeroSergeants" style="display: inline">0</div><button id="btnMoveSergeantToGarrison" onclick="game.moveSergeantsToGarnison()">↑</button>
					</td>
					<td>
						turkopols: <div id="lblHeroTurkopols" style="display: inline">0</div><button id="btnMoveTurkopolToGarrison" onclick="game.moveTurkopolsToGarnison()">↑</button>
					</td>
					<td>
						knights: <div id="lblHeroKnights" style="display: inline">0</div><button id="btnMoveKnightToGarrison" onclick="game.moveKnightsToGarnison()">↑</button>
					</td>
				</tr>
			</table>
		</div>
		<div id="Discord" class="tabcontent">
			<iframe src="https://discordapp.com/widget?id=564554640755130409&theme=light" width="800" height="470" allowtransparency="true" frameborder="0"></iframe>
		</div>
		<div id="console_n_chat" name="console_n_chat" class="interface" value="" style="width:800px; height:150px; top: 540px; left: 10px"></div>
		<canvas id="myDCanvas" width="700" height="200" style="position: absolute; left: 20px; top: 100px; z-index: -2; visible:none">
		Your browser does not support the HTML5 canvas tag.</canvas>
</div>
<script>
	//TOWN
	canvas  = document.getElementById("canvas");
	canvas.addEventListener("touchstart", tap);
	canvas.addEventListener("mousedown", tap);
	languageDefined = 0;
	var ctx     = canvas.getContext("2d");
	var img1    = loadImage('resources/background_a.png', composite);//use forward slashes for Linux and Windows compatible. \ this slash works only in Windows.
	var img2    = loadImage('resources/sawmill_a.png', composite);
	var sawmillX     = 670;
	var sawmillY	 = 65;
	var sawmillW     = 110;
	var sawmillH     = 56;
	var img3    = loadImage('resources/gold_a.png', composite);
	var goldX        = 10;
	var goldY   	 = 40;
	var goldW        = 28;
	var goldH        = 22;
	var img4    = loadImage('resources/pop_a.png', composite);
	var popX         = 10;
	var popY   	     = 80;
	var popW         = 29;
	var popH         = 22;
	var img5    = loadImage('resources/home_as.png', composite);
	var homeX        = 90;
	var homeY   	 = 160;
	var homeW        = 80;
	var homeH        = 90;
	var img5_1  = loadImage('resources/house_as.png', composite);
	var houseX       = 90;
	var houseY   	 = 160;
	var houseW       = 113;
	var houseH       = 125;
	var img6_1  = loadImage('resources/wallsr_a.png', composite);
	var img6_2  = loadImage('resources/wallsf_a.png', composite);
	var wallX        = 330;
	var wallY   	 = 400;
	var wallW        = 110;
	var wallH        = 65;
	var img7    = loadImage('resources/castle_as.png', composite);
	var castleX      = 300;
	var castleY      = 160;
	var castleW      = 180;
	var castleH      = 160;
	var img8    = loadImage('resources/wishing_well_builded.png', composite);
	var wellX        = 230;
	var wellY      	 = 200;
	var wellW        = 41;
	var wellH        = 47;
	var img9    = loadImage('resources/treasury_as.png', composite);
	var treasuryX    = 200;
	var treasuryY    = 270;
	var treasuryW    = 125;
	var treasuryH    = 120;
	var img10   = loadImage('resources/gallows.png', composite);
	var gallowsX     = 485;
	var gallowsY   	 = 270;
	var gallowsW     = 50;
	var gallowsH     = 75;
	var img11   = loadImage('resources/fountain.png', composite);
	var fountainX    = 485;
	var fountainY    = 290;
	var fountainW    = 70;
	var fountainH    = 55;
	var img12   = loadImage('resources/trapdoor.png', composite);
	//var img13 is already used in fire singleton
	var img14   = loadImage('resources/inn.png', composite);
	var innX = 270;
	var innY = 80;
	var innW = 87;
	var innH = 79;
	var img15   = loadImage('resources/fire_a.gif', composite);
	img15.id      = "fire_graphics";
	var img16   = loadImage('resources/stable.png', composite);
	var stableX = 480;
	var stableY = 100;
	var stableW = 160;
	var stableH = 120;
	buildingsInTownB=[];
	buildingsInTownX=[];
	buildingsInTownY=[];
	buildingsInTownW=[];
	buildingsInTownH=[];
	function deleteFromArray (arrayToMod, indexToDelete) {
		arrayLenght                = arrayToMod.length;
		tArrayBeforeDeletedElement = arrayToMod.slice(0,indexToDelete);
		tArrayAfterDeletedElement  = arrayToMod.slice(indexToDelete+1,arrayToMod.length);
		tResultArray               = tArrayBeforeDeletedElement.concat(tArrayAfterDeletedElement);
		return tResultArray;
	}
	function removeFromArrays (elementIndex) {
		buildingsInTownB = deleteFromArray(buildingsInTownB, elementIndex);
		buildingsInTownX = deleteFromArray(buildingsInTownX, elementIndex);
		buildingsInTownY = deleteFromArray(buildingsInTownY, elementIndex);
		buildingsInTownW = deleteFromArray(buildingsInTownW, elementIndex);
		buildingsInTownH = deleteFromArray(buildingsInTownH, elementIndex);
	}
	var Singleton = (function () {
		var instance;
		function createInstance() {
			var object = loadImage('resources/fire_static.png');
			return object;
		}
		return {
			getInstance: function () {
				if (!instance) {
					instance = createInstance();
				}
				return instance;
			}
		};
	})();
	//var imagesLoaded = 0;
	function pushBuilding(buildingName, buildingX, buildingY, buildingW, buildingH){
		if (buildingsInTownB.indexOf(buildingName)==-1) {
			if (buildingName==='house') {
				removeIndex = buildingsInTownB.indexOf('home');
				removeFromArrays(removeIndex);
			}
			if (buildingName==='swall') {
				removeIndex = buildingsInTownB.indexOf('wall');
				removeFromArrays(removeIndex);
			}
			if (buildingName==='scastle') {
				removeIndex = buildingsInTownB.indexOf('scastle');
				removeFromArrays(removeIndex);
			}
			buildingsInTownB.push(buildingName);
			buildingsInTownX.push(buildingX);
			buildingsInTownY.push(buildingY);
			buildingsInTownW.push(buildingW);
			buildingsInTownH.push(buildingH);
		}
	}
	function composite() {
		ctx.drawImage(img1, 0, 0);   //draw background
		ctx.drawImage(img2, sawmillX, sawmillY);//draw sawmill
		pushBuilding('sawmill', sawmillX, sawmillY, sawmillW, sawmillH);
		ctx.drawImage(img3, goldX, goldY); //draw gold icon
		pushBuilding('gold', goldX, goldY, goldW, goldH);
		ctx.drawImage(img4, popX, popY); //draw pop  icon
		pushBuilding('pop', popX, popY, popW, popH);
		ctx.drawImage(img8, wellX, wellY); //draw wishing well
		pushBuilding('well', wellX, wellY, wellW, wellH);
		if (game.buildLevelD > 0) {
			// draw back piece of wall
			ctx.drawImage(img6_1, 0, 0);
		}
		if (game.buildLevelH > 0 && game.buildLevelH < 10) {
			// draw homes
			ctx.drawImage(img5, homeX, homeY);
			pushBuilding('home', homeX, homeY, homeW, homeH);
		}
		if (game.buildLevelH >= 10) {
			// draw more houses
			ctx.drawImage(img5_1, houseX, houseY);
			pushBuilding('house', houseX, houseY, houseW, houseH);
		}
		if (game.buildLevelD > 1) {
			// draw castle
			ctx.drawImage(img7, castleX, castleY);
			pushBuilding('castle', castleX, castleY, castleW, castleH);
		}
		if (game.buildLevelTreasury > 0) {
			// draw treasury
			ctx.drawImage(img9, treasuryX, treasuryY);
			pushBuilding('treasury', treasuryX, treasuryY, treasuryW, treasuryH);
		}
		if (game.buildLevelGallows > 0) {
			// draw gallows
			ctx.drawImage(img10, gallowsX, gallowsY);
			pushBuilding('gallows', gallowsX, gallowsY, gallowsW, gallowsH);
		}
		if (game.buildLevelFountain > 0) {
			// draw fountain
			ctx.drawImage(img11, fountainX, fountainY);
			pushBuilding('fountain', fountainX, fountainY, fountainW, fountainH);
		}
		if (game.buildLevelStash > 0) {
			// draw stash
			//We do not draw a secret Stash under the Treasury. It's a secret, are you understand?!
			//ctx.drawImage(img12, 0, 0);
		}
		if (game.buildLevelInn > 0) {
			ctx.drawImage(img14, innX, innY);
			pushBuilding('inn', innX, innY, innW, innH);
		}
		if (game.buildLevelD > 0) {
			// draw front piece of wall
			ctx.drawImage(img6_2, 0, 0);
			//pushing gatehouse of the wall
			pushBuilding('wall', wallX, wallY, wallW, wallH);
		}
		if (game.buildLevelStable > 0) {
			// draw front piece of wall
			ctx.drawImage(img16, stableX, stableY);
			//pushing gatehouse of the wall
			pushBuilding('stable', stableX, stableY, stableW, stableH);
		}
		if (game.fire === 1) {
			img15.style   = 'position:absolute; top:370px; left:200px; z-index:8';
			document.getElementById("events_graphics").appendChild(img15);
			//img15.style   = 'position:absolute; top:170px; left:0px; z-index:8';
			document.getElementById("fire_graphics").setAttribute("onclick", "game.putOutFire()");
			document.getElementById("buttonPutOutFire").setAttribute("style", "top:390px; left: 20px; display:true");
		}
	}
	function loadImage(src, onload) {
		var img = new Image();
		img.onload = onload;
		img.src = src;
		return img;
	}
	function getElementPosition (element) {
		//thanks to William Alone
		var parentOffset,
				pos = {
					x: element.offsetLeft,
					y: element.offsetTop
				};
		if (element.offsetParent) {
			parentOffset = getElementPosition(element.offsetParent);
			pos.x += parentOffset.x;
			pos.y += parentOffset.y;
		}
		return pos;
	}
	function tap (e) {
		pos = getElementPosition(canvas);
		loc = {};
		tapX = e.targetTouches ? e.targetTouches[0].pageX : e.pageX;
		tapY = e.targetTouches ? e.targetTouches[0].pageY : e.pageY;
		canvasScaleRatio = canvas.width / canvas.offsetWidth;
		loc.x = (tapX - 9) * canvasScaleRatio;
		loc.y = (tapY - 58) * canvasScaleRatio;
		for (bi=0;bi<buildingsInTownB.length;bi++){
			if (loc.x >= buildingsInTownX[bi] && loc.x <= buildingsInTownX[bi]+buildingsInTownW[bi]) {
				if (loc.y >= buildingsInTownY[bi] && loc.y <= buildingsInTownY[bi]+buildingsInTownH[bi]) {
					console.log(buildingsInTownB[bi]);
					buildingClick(buildingsInTownB[bi]);
				}
			}
		}
	}
	function buildingClick(buildingName){
		var showAlert = true;
		alertMsg = "";
		if (buildingName==='well') {
			showAlert = false;
			//TODO make a dialog with lootboxes
		}
		if (buildingName==='gold') {
			showAlert = false;
			checkGold();
		}
		if (buildingName==='pop') {
			//alertMsg = localeStrings[145];
			showAlert = false;
			checkPop();
		}
		if (buildingName==='sawmill') {
			showAlert = false;
			//alertMsg = localeStrings[133];
		}
		if (buildingName==='wall') {
			alertMsg = localeStrings[134];
		}
		if (buildingName==='swall') {
			alertMsg = localeStrings[135];
		}
		if (buildingName==='home') {
			showAlert = false;
			checkPop();
		}
		if (buildingName==='house') {
			showAlert = false;
			checkPop();
		}
		if (buildingName==='castle') {
			alertMsg = localeStrings[136];
		}
		if (buildingName==='scastle') {
			alertMsg = localeStrings[137];
		}
		if (buildingName==='inn') {
			//alertMsg = localeStrings[140];
			showAlert = false;
			openTab(null, 'tabInn');
		}
		if (buildingName==='gallows') {
			alertMsg = localeStrings[141];
		}
		if (buildingName==='fountain') {
			showAlert = false;
			game.makeFestival();
		}
		if (buildingName==='treasury') {
			alertMsg = localeStrings[143];
		}
		if (buildingName==='stable') {
			showAlert = false;
			updateUI();
			openTab(null, 'tabTroopsHiring');
		}
		if (showAlert === true &&  alertMsg !=="" ) {
			showModal(0, '', getAck, alertMsg,  localeStrings[60], '')
		}
	}
	//composite();
</script>
<script>
	//GLOBALMAP
	var canvas_map      = document.getElementById("canvasMap");
	var ctx_map         = canvas_map.getContext("2d");
	var tile_grass      = loadImage('tiles/grass.png');//use forward slashes for Linux and Windows compatible. \ this slash works only in Windows.
	var tile_sand       = loadImage('tiles/sand.png');
	var tile_snow       = loadImage('tiles/snow.png');
	var tile_water      = loadImage('tiles/water.png');
	var castle_tile     = loadImage('resources/castle_big.png');
	var hero_tile       = loadImage('resources/someKnight3.png');
	var tree_tile       = loadImage('resources/tree.png');
	function composite_gm() {
		for (i = 0; i < config.sizeMapX; i++) {
			for (j = 0; j < config.sizeMapY; j++) {
				if (game.myMapLand[i][j]===0) {
					ctx_map.drawImage(tile_grass, i * 48, j * 48);   //draw background
				}
			}
		}
		for (i = 0; i < config.sizeMapX; i++) {
			for (j = 0; j < config.sizeMapY; j++) {
				if (game.myMapLand[i][j]===0) {
					//ctx_map.drawImage(tile_grass, i * 48, j * 48);   //draw background
				}
				if (game.myMapObjects[i][j]===1) {
					//console.log("draw tree");
					ctx_map.drawImage(tree_tile, i * 48, j * 48);   //draw castle entrance
				}
				if (game.myMapObjects[i][j]===2) {
					//console.log("draw tree");
					ctx_map.drawImage(tree_tile, i * 48, j * 48);   //draw castle entrance
				}
				if (game.myMapObjects[i][j]===3) {
					//console.log("draw tree");
					ctx_map.drawImage(tree_tile, i * 48, j * 48);   //draw castle entrance
				}
				if (game.myMapObjects[i][j]===12) {
					console.log("draw castle");
					ctx_map.drawImage(castle_tile, i * 48, j * 48);   //draw castle entrance
				}
				if (game.myMapRemObjects[i][j]===40) {
					console.log("draw hero");
					game.heroX = i;
					game.heroY = j;
					ctx_map.drawImage(hero_tile, i * 48, j * 48);   //draw hero
				}
			}
		}
	}
</script>
<script>
	include = function (url, fn) {
		var e = document.createElement("script");
		e.onload = fn;
		e.src = url;
		e.async=true;
		document.getElementsByTagName("head")[0].appendChild(e);
	};
	//init variables
	var game = {
		gold:20,
		pop:2,
		season:2, //1 - Winter, 2 - Spring, 3 - Summer, 4 - Autumn
		year:1255,
		food:20,
		treasuryGuard:0,
		buildLevelD:0,
		buildLevelH:0,
		buildLevelTreasury:0,
		buildLevelGallows:0,
		buildLevelFountain:0,
		buildLevelStash:0,
		buildLevelInn:0,
		buildLevelStable:0,
		buildLevelArchery:0,
		buildLevelSmith:0,
		fire:0,
		hero:0,
		happiness:80,
		o_autosave:0,
		saveVersion:"saveV1008",
		myGlobalMap: [],
		myMapLand: [],
		castleX: 1,
		castleY: 1,
		heroX: 1,
		heroY: 1,
		myMapObjects: [],
		myMapRemObjects: [],
		years: [],
		pops: [],
		budgets: [],
		userPopAck: 0,
		userGoldAck: 0,
		userASaveAck: 0,
		isHero: 0,//do I need this?
		cityWarehouse: [], //should the list contain objects?
		myhero: {},
		festival_cooldown: 0,
		sergeants: 0,
		turkopols: 0,
		knights: 0,
		checkCollisionWithBordersOfMap : function (changeX, changeY) {
			if (game.heroX+changeX<0){
				return true;
			}
			if (game.heroY+changeY<0){
				return true;
			}
			if (game.heroX+changeX>config.sizeMapX-1){
				return true;
			}
			if (game.heroY+changeY>config.sizeMapY-1){
				return true;
			}
			return false;
		},
		checkCollisionWithNonRemovableObstacles : function (changeX, changeY) {
			if (game.myMapObjects[game.heroX+changeX][game.heroY+changeY]===0) {
				return false;
			} else {
				return true;
			}
		},
		checkColissionWithRemovableObstacles : function () {

		},
		tryHeroMovement : function (changeX, changeY) {
			console.log("we are here!");
			if (game.checkCollisionWithBordersOfMap(changeX, changeY)===false) {
				if (game.checkCollisionWithNonRemovableObstacles(changeX, changeY)===false) {
					game.myMapRemObjects[game.heroX][game.heroY] = 0;
					game.heroX = game.heroX + changeX;
					game.heroY = game.heroY + changeY;
					game.myMapRemObjects[game.heroX][game.heroY] = 40;
					composite_gm();
				}
			}
		},
		cityLeave : function () {
			var heroExists = (Object.keys(game.myhero).length===0 && game.myhero.constructor === Object) ? false : true;
			if (heroExists===true && game.myhero.status === 0) {
				game.myhero.status = 2;
				openTab(null, 'Explore');
				updateUI();
			}
		},
		cityEnter : function () {
			var heroExists = (Object.keys(game.myhero).length===0 && game.myhero.constructor === Object) ? false : true;
			if (heroExists===true && game.myhero.status === 2) {
				game.myhero.status = 0;
				updateUI();
			}
		},
		heroDismiss: function () {
			var heroExists = (Object.keys(game.myhero).length===0 && game.myhero.constructor === Object) ? false : true;
			if (heroExists===true){
				if (game.isHeroHaveTroops()) {
					var question      = "Do you want to dismiss hero with all troops?";
					showModal(1, '', game.heroDismissCallback, question, "Yes, I would like to",  "Nope. I will move all units from the hero.");
				} else {
					game.heroDie();
				}
			} else {
				alertMsg = "You need a hero to do that!";
				showModal(0, '', getAck, alertMsg,  localeStrings[60], '');
			}
		},
		heroDismissCallback : function () {
			if (answer === 2){
				game.heroDie();
			}
		},
		calculateAutocampaign : function () {
			var heroExists = (Object.keys(game.myhero).length===0 && game.myhero.constructor === Object) ? false : true;
			if (heroExists === true && game.myhero.status===1 && game.myhero.aCampaignForward===1) {
				game.myhero.aCampaignLong         += 1;
				console.log("random stuff on the way forward");
				var heroTroopsPrice = game.heroTroopsPrice();
				var rnd = Math.floor((Math.random() * 24) + 1);
				if (game.myhero.aCampaignLong===0){
					postJournalLog("------------------------");
				}
				if (game.myhero.stance === 0) {//aggressive stance
					if (rnd===1) {
						//you got killed
						postJournalLog("the hero and all troops met their death in the glory combat");
						game.heroDie();
					}
					if (rnd>1 && rnd<=12) {
						game.myhero.gold += Math.floor(heroTroopsPrice*1.05+1);
						game.myhero.exp  += Math.floor(heroTroopsPrice*1.05+1);
						postJournalLog("the hero has met great number of enemies and crash them. The battle brings to the hero money and experience!");
					}
					if (rnd>12 && rnd<25) {
						postJournalLog("the day was very boring. Only one pagan was killed (a hunter took a pagan as a prey. so sad!)");
					}
				}
				if (game.myhero.stance === 1) {//cautious stance
					if (rnd>1 && rnd<=12) {
						game.myhero.gold += Math.floor(heroTroopsPrice*0.35+1);
						game.myhero.exp  += Math.floor(heroTroopsPrice*0.35+1);
						postJournalLog("the hero has met small number of enemies and crash them. The battle brings to the hero money and experience!");
					}
					if (rnd>12 && rnd<25) {
						postJournalLog("the day was very boring. Only one pagan was killed (a hunter took a pagan as a prey. so sad!)");
					}
				}
				game.heroLvlUp();
			}
			if (heroExists === true && game.myhero.status===1 && game.myhero.aCampaignBackward===1) {
				if (game.myhero.aCampaignLong-1>0){
					game.myhero.aCampaignLong     -= 1;
					postJournalLog("the day was very boring. Only one pagan was killed (a hunter took a pagan as a prey. so sad!)");
				} else {
					game.myhero.aCampaignLong      = 0;
					game.myhero.status             = 0;
					game.myhero.aCampaignForward   = 0;
					game.myhero.aCampaignBackward  = 0;
					postEventLog("the hero brings to you this lot of gold from adventure: "+game.myhero.gold);
					game.gold                     += game.myhero.gold;
					game.myhero.gold               = 0;
				}
				game.heroLvlUp();
			}
		},
		isHeroHaveTroops : function () {
			var heroTroopsFlag = false;
			var heroExists = (Object.keys(game.myhero).length===0 && game.myhero.constructor === Object) ? false : true;
			if (heroExists === true) {
				var totalCount = game.myhero.sergeants*1+game.myhero.turkopols*1+game.myhero.knights*1;
				if (totalCount>0) {
					heroTroopsFlag = true;
				}
			}
			return heroTroopsFlag;
		},
		heroTroopsPrice : function () {
			var price = 0;
			price    += game.myhero.sergeants*20;
			price    += game.myhero.turkopols*20;
			price    += game.myhero.knights*40;
			return price;
		},
		autocampaign : function () {
			var heroExists = (Object.keys(game.myhero).length===0 && game.myhero.constructor === Object) ? false : true;
			if (heroExists===true){
				if (game.myhero.status===0) {
					if (game.isHeroHaveTroops()) {
						var question      = "Do you want aggressive stance (higher reward, higher risk) or cautious one?";
						showModal(1, '', game.autocampaignLaunchCallback, question, "Aggressive! Wanna blood and money!",  "Cautious. What good of gold if you are dead?");
					} else {
						alertMsg = "You need to add some troops to hero's squed first!";
						showModal(0, '', getAck, alertMsg,  localeStrings[60], '');
					}
				} else {
					if (game.myhero.status===1) {
						var question      = "Do you want withdraw your hero?";
						showModal(1, '', game.autocampaignWithdrawCallback, question, "Yes",  "No");
					} else {
						alertMsg = "You need a hero in town to do that!";
						showModal(0, '', getAck, alertMsg,  localeStrings[60], '');
					}
				}
			} else {
				alertMsg = "You need a hero to do that!";
				showModal(0, '', getAck, alertMsg,  localeStrings[60], '');
			}
		},
		autocampaignLaunchCallback : function () {
			if (answer === 2) {
				game.myhero.stance = 0;
			}
			if (answer === 3) {
				game.myhero.stance = 1;
			}
			game.myhero.status = 1;
			game.myhero.aCampaignForward   = 1;
			game.myhero.aCampaignBackward  = 0;
			updateUI();
		},
		autocampaignWithdrawCallback : function () {
			if (answer === 2) {
				if (game.myhero.aCampaignLong === 0) {
					game.myhero.status = 0;
					updateUI();
				} else {
					game.myhero.aCampaignForward   = 0;
					game.myhero.aCampaignBackward  = 1;
				}
			}
		},
		help(myobject) {
			console.log(myobject.id);
			if (myobject.id==="defencies_img") {
				document.getElementById("lblBuildHelp").innerHTML=localeStrings[230];
			}
			if (myobject.id==="home_img") {
				document.getElementById("lblBuildHelp").innerHTML=localeStrings[233];
			}
			if (myobject.id==="treasury_img") {
				document.getElementById("lblBuildHelp").innerHTML=localeStrings[234];
			}
			if (myobject.id==="gallows_img") {
				document.getElementById("lblBuildHelp").innerHTML=localeStrings[235];
			}
			if (myobject.id==="fountain_img") {
				document.getElementById("lblBuildHelp").innerHTML=localeStrings[236];
			}
			if (myobject.id==="moneystash_img") {
				document.getElementById("lblBuildHelp").innerHTML=localeStrings[237];
			}
			if (myobject.id==="inn_img") {
				document.getElementById("lblBuildHelp").innerHTML=localeStrings[238];
			}
			if (myobject.id==="stable_img") {
				document.getElementById("lblBuildHelp").innerHTML=localeStrings[239];
			}
		},
		heroAlignment(returnFormat) {
			if (returnFormat==="text") {
				var heroAlignment = "";
				if (game.myhero.lawful < 40) {
					heroAlignment += "Chaotic";
				}
				if (game.myhero.lawful >= 40 && game.myhero.lawful <60) {
					heroAlignment += "Neutral";
				}
				if (game.myhero.lawful >= 60) {
					heroAlignment += "Lawful";
				}
				if (game.myhero.kindness < 40) {
					heroAlignment += " "+"Evil";
				}
				if (game.myhero.kindness >= 40 && game.myhero.kindness <60) {
					heroAlignment += " "+"Neutral";
				}
				if (game.myhero.kindness >= 60) {
					heroAlignment += " "+"Good";
				}
				heroAlignment += " ("+game.myhero.lawful+"; "+game.myhero.kindness+")";
			}
			return heroAlignment;
		},
		heroNextLvlExpLimit () {
			return Math.pow((game.myhero.level+1) * config.heroExpK,2);
		},
		heroHire : function () {
			var heroExists = (Object.keys(game.myhero).length===0 && game.myhero.constructor === Object) ? false : true;
			if (heroExists === false) {
				if (game.gold > config.costHero) {
					console.log('hero hired');
					game.gold                 = game.gold - config.costHero;
					game.myhero.level         = game.buildLevelInn;
					game.myhero.exp           = Math.pow(game.myhero.level * config.heroExpK,2);
					var x = document.getElementById("selectHeroClass").selectedIndex;
					var y = document.getElementById("selectHeroClass").options;
					var heroclass             = y[x].value; //y[x].id, text, index
					game.myhero.class         = parseInt(heroclass);
					if (game.myhero.class===0){
						game.myhero.atk       = 2;
						game.myhero.def       = 2;
						game.myhero.mpow      = 0;
						game.myhero.mana      = 0;
						game.myhero.cmana     = 0;
						game.myhero.lawful    = 80;
						game.myhero.kindness  = 50;
					}
					if (game.myhero.class===1){
						game.myhero.atk       = 0;
						game.myhero.def       = 0;
						game.myhero.mpow      = 2;
						game.myhero.mana      = 20;
						game.myhero.cmana     = 20;
						game.myhero.lawful    = 80;
						game.myhero.kindness  = 70;
					}
					game.myhero.sergeants = 0;
					game.myhero.turkopols = 0;
					game.myhero.knights   = 0;
					game.myhero.inventory = [];//should the list contain objects?
					game.myhero.status    = 0;
					game.myhero.gold      = 0;
					game.myhero.aCampaign          =0;
					game.myhero.aCampaignLong      =0;
					game.myhero.aCampaignForward   =0;
					game.myhero.aCampaignBackward  =0;
					updateHeroStatus();
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[20]);
					postEventLog(msg);
				}
			} else {
				alertMsg = localeStrings[61];
				showModal(0, '', getAck, alertMsg,  localeStrings[60], '');
			}
		},
		heroLvlUp : function () {
			console.log("check hero exp for level up");
			console.log("current hero exp is "+game.myhero.exp);
			console.log("current hero next lvl is "+game.heroNextLvlExpLimit());
			if (game.myhero.exp > game.heroNextLvlExpLimit()){
				game.myhero.level +=1;
				postJournalLog("Your hero got promoted to the next level!");
			}
		},
		heroDie : function () {
			game.myhero = {};
			updateHeroStatus();
			writeSave();
		},
		hireTroopsSergeant : function () {
			if (game.gold > 20 && game.buildLevelStable>=1) {
				game.sergeants += 1;
				game.gold      -= 20;
				updateTroopsNumbers();
			}
		},
		hireTroopsTurkopol : function () {
			if (game.gold > 20 && game.buildLevelStable>=1 && game.buildLevelArchery>=1) {
				game.turkopols += 1;
				game.gold      -= 20;
				updateTroopsNumbers();
			}
		},
		hireTroopsKnight : function () {
			if (game.gold > 40 && game.buildLevelStable>=2) {
				game.knights   += 1;
				game.gold      -= 40;
				updateTroopsNumbers();
			}
		},
		moveSergeantsToHero : function () {
			if (game.myhero.status===0&&game.sergeants>0){
				game.sergeants        -= 1;
				game.myhero.sergeants += 1;
				updateTroopsNumbers();
			}
		},
		moveTurkopolsToHero : function () {
			if (game.myhero.status===0&&game.turkopols>0){
				game.turkopols        -= 1;
				game.myhero.turkopols += 1;
				updateTroopsNumbers();
			}
		},
		moveKnightsToHero : function () {
			if (game.myhero.status===0&&game.knights>0){
				game.knights          -= 1;
				game.myhero.knights   += 1;
				updateTroopsNumbers();
			}
		},
		moveSergeantsToGarnison : function () {
			if (game.myhero.status===0&&game.myhero.sergeants>0){
				game.sergeants        += 1;
				game.myhero.sergeants -= 1;
				updateTroopsNumbers();
			}
		},
		moveTurkopolsToGarnison : function () {
			if (game.myhero.status===0&&game.myhero.turkopols>0){
				game.turkopols        += 1;
				game.myhero.turkopols -= 1;
				updateTroopsNumbers();
			}
		},
		moveKnightsToGarnison : function () {
			if (game.myhero.status===0&&game.myhero.knights>0){
				game.knights          += 1;
				game.myhero.knights   -= 1;
				updateTroopsNumbers();
			}
		},
		goldLimit : function () {
			return Math.pow(config.costTreasury,(game.buildLevelTreasury*1+1))*2+500;
		},
		popLimit : function () {
			return 2*Math.pow((game.buildLevelH*1+3),2);
		},
		createTheGlobalMap : function () {
			for (i = 0; i < 4; i++) {
				for (j = 0; j < 4; j++) {
					game.myGlobalMap[i][j] = 1;
				}
			}
		},
		recordStats : function() {
			game.years.push(game.year+" "+game.season);
			game.budgets.push(game.gold);
			game.pops.push(game.pop);
		},
		calculateTurn : function() {
			game.recordStats();
			pop_m         = 0;
			pop_was       = game.pop;
			game.season   = game.season + 1;
			if (game.season === 5) {
				game.season   = 1;
				game.year     = game.year+1;
			}
			gold_was      = game.gold;
			gold_limit    = game.goldLimit();
			gold_possible = game.gold*1+Math.round(game.pop*(1+game.buildLevelGallows*1/10),0);
			if (gold_possible > gold_limit) {
				game.gold      = gold_limit;
				if (game.userGoldAck === 0) {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[3]);
					postEventLog(msg);
					game.userGoldAck = 1;
				}
			} else {
				game.gold      = gold_possible;
				game.userGoldAck = 0;
			}
			pop_limit = game.popLimit();
			if (game.fire ===0) {
				if (game.pop < pop_limit) {
					pop_incr = Math.round((game.pop*20/1000)*(1+game.buildLevelFountain*1/10),0)
					if (pop_incr == 0) {
						game.pop = game.pop*1+1;
					} else {
						game.pop = game.pop*1+pop_incr*1;
					}
					pop_m    = 1;
					game.userPopAck = 0;
				} else {
					if (game.userPopAck === 0) {
						msg = "<b>%arg1</b>";
						msg = msg.replace("%arg1",localeStrings[10]);
						postEventLog(msg);
						game.userPopAck = 1;
					}
				}
			}
			if (game.treasuryGuard > 0) {
				if (game.gold - game.treasuryGuard * config.treasuryGuardPricePayroll >= 0) {
					game.gold = game.gold - game.treasuryGuard * config.treasuryGuardPricePayroll;
				}
				else {
					//fire guards which we cannot afford
					//for now fire all guards!
					//TODO fire only those who we cannot afford
					game.treasuryGuard = 0;
					msg   = localeStrings[37];
					postEventLog(msg);
				}
			}
			game.calculateAutocampaign();
			if (game.sergeants > 0) {
				if (game.gold - game.sergeants * 5 >= 0) {
					game.gold = game.gold - game.sergeants * 5;
				}
				else {
					//fire guards which we cannot afford
					//for now fire all guards!
					//TODO fire only those who we cannot afford
					game.sergeants = 0;
					msg   = "you can't afford upkeeping of your sergeants. they are dismissed";
					postEventLog(msg);
				}
			}
			if (game.gold !== gold_was) {
				if (game.gold > gold_was) {
					msg = localeStrings[4];
				} else {
					msg = localeStrings[5];
				}
				postEventLog(msg);
			};
			if (game.pop !== pop_was) {
				if (game.pop > pop_was) {
					msg = localeStrings[7];
				} else {
					msg = localeStrings[8];
				}
				postEventLog(msg);
			};
			cnt_cursession = cnt_cursession+1;
			if (cnt_cursession===10) {
				//TODO
				//ym(47225574, 'reachGoal', 'min5');
				//return true;
			}
			updateUI();
		},
		makeFestival : function() {
			var festivalPrice = game.pop*config.festPrice*(game.buildLevelTreasury+1)*(game.buildLevelFountain+1);
			question      = localeStrings[56].replace("%arg1", festivalPrice);
			if (game.festival_cooldown !==0) {
				question += localeStrings[57];
			}
			showModal(1, '', game.makeFestivalCallback, question, localeStrings[32], localeStrings[33])
		},
		makeFestivalCallback : function() {
			var festivalPrice = game.pop*config.festPrice*(game.buildLevelTreasury+1)*(game.buildLevelFountain+1);
			if (answer === 2) {
				if (game.gold>=festivalPrice) {
					var gold_diff = 0-festivalPrice+Math.floor(festivalPrice*(30-game.festival_cooldown)/30*1.05+2*(game.buildLevelFountain+1));
					if (gold_diff >=0) {
						if (game.gold + gold_diff > game.goldLimit()) {
							game.gold = game.goldLimit();
							msg = "<b>%arg1</b>";
							msg = msg.replace("%arg1",localeStrings[3]);
							postEventLog(msg);
						} else {
							game.gold += gold_diff;
						}
						msg = localeStrings[59][0].replace("%arg1",gold_diff);
						postEventLog(msg);
					} else {
						game.gold += gold_diff;
						msg = localeStrings[59][1].replace("%arg1",gold_diff);
						postEventLog(msg);
					}
					game.festival_cooldown  = config.festCooldown;
					updateResources();
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[20]);
					postEventLog(msg);
				}
			}
		},
		Build : function (Structure) {
			if (Structure==="Wall" || Structure ==="Tower") {
				if (game.gold >= config.costWall && game.buildLevelD == 0) {
					game.buildLevelD        = game.buildLevelD*1 + 1;
					game.gold               = game.gold - config.costWall;
					commonBuild();
					return true;
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[20]);
					postEventLog(msg);
				}
				if (game.gold >= config.costTower && game.buildLevelD == 1) {
					game.buildLevelD        = game.buildLevelD*1 + 1;
					game.gold               = game.gold - config.costTower;
					commonBuild();
					return true;
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[20]);
					postEventLog(msg);
				}
			}
			if (Structure==="Home") {
				if (game.gold >= Math.pow(config.costHome,(game.buildLevelH*1 + 1))) {
					game.gold               = game.gold - Math.pow(config.costHome,(game.buildLevelH*1 + 1));
					game.buildLevelH        = game.buildLevelH*1 + 1;
					commonBuild();
					return true;
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[20]);
					postEventLog(msg);
				}
			}
			if (Structure==="Treasury") {
				if (game.gold >= Math.pow(config.costTreasury,(game.buildLevelTreasury*1 + 1))) {
					game.gold               = game.gold - Math.pow(config.costTreasury,(game.buildLevelTreasury*1 + 1));
					game.buildLevelTreasury = game.buildLevelTreasury*1 + 1;
					commonBuild();
					return true;
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[20]);
					postEventLog(msg);
				}
			}
			if (Structure==="Gallows") {
				if (game.gold >= Math.pow(config.costGallows,(game.buildLevelGallows*1 + 1)) && game.buildLevelFountain == 0) {
					game.gold               = game.gold - Math.pow(config.costGallows,(game.buildLevelGallows*1 + 1));
					game.buildLevelGallows  = game.buildLevelGallows*1 + 1;
					commonBuild();
					return true;
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[20]);
					postEventLog(msg);
				}
			}
			if (Structure==="Fountain") {
				if (game.gold >= Math.pow(config.costFountain,(game.buildLevelFountain*1 + 1)) && game.buildLevelGallows == 0) {
					game.gold               = game.gold - Math.pow(config.costFountain,(game.buildLevelFountain*1 + 1));
					game.buildLevelFountain = game.buildLevelFountain*1 + 1;
					commonBuild();
					return true;
				}
			}
			if (Structure==="Stash") {
				if (game.gold >= Math.pow(config.costStash,(game.buildLevelStash*1 + 1)) && game.buildLevelTreasury*1 > 0) {
					game.gold               = game.gold - Math.pow(config.costStash,(game.buildLevelStash*1 + 1));
					game.buildLevelStash    = game.buildLevelStash*1 + 1;
					commonBuild();
					return true;
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[20]);
					postEventLog(msg);
				}
			}
			if (Structure==="Inn") {
				if (game.gold >= Math.pow(config.costInn,(game.buildLevelInn*1 + 1))) {
					game.gold               = game.gold - Math.pow(config.costInn,(game.buildLevelInn*1 + 1));
					game.buildLevelInn      = game.buildLevelInn*1 + 1;
					if (game.buildLevelInn===1) {
						generateMap();
					}
					commonBuild();
					return true;
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[20]);
					postEventLog(msg);
				}
			}
			if (Structure==="Stable") {
				if (game.gold >= Math.pow(config.costStable,(game.buildLevelStable*1 + 1))) {
					game.gold               = game.gold - Math.pow(config.costStable,(game.buildLevelStable*1 + 1));
					game.buildLevelStable   = game.buildLevelStable*1 + 1;
					commonBuild();
					return true;
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[20]);
					postEventLog(msg);
				}
			}
			function commonBuild() {
				updateResources();
				composite();
				updateButtonCaptions();
			}
		},
		buildGallowsOrFountain(objectToBuild) {
			var costOfBuilding = 0;
			if (objectToBuild==="Fountain") {
				costOfBuilding = config.costFountain;
				question = localeStrings[64].replace("%arg1",localeStrings[142]).replace("%arg2",localeStrings[141]);
			}
			if (objectToBuild==="Gallows") {
				costOfBuilding = config.costGallows;
				question = localeStrings[64].replace("%arg1",localeStrings[141]).replace("%arg2",localeStrings[142]);
			}
			if (game.gold > costOfBuilding) {
				if (game.buildLevelFountain === 0 && game.buildLevelGallows === 0) {
					the_objectToBuild = objectToBuild;
					showModal(1, '', game.buildGallowsOrFountainCallback, question, localeStrings[32], localeStrings[33])
				} else {
					game.Build(objectToBuild);
				}
			} else {
				msg = "<b>%arg1</b>";
				msg = msg.replace("%arg1",localeStrings[20]);
				postEventLog(msg);
			}
		},
		buildGallowsOrFountainCallback() {
			if (answer === 2) {
				game.Build(the_objectToBuild);
			}
		},
		hireTreasuryGuard : function () {
			if (game.buildLevelTreasury >= 1) {
				question = localeStrings[18].replace("%arg1",config.treasuryGuardPriceHire).replace("%arg2",config.treasuryGuardPricePayroll);;
				showModal(1, '', game.hireTreasuryGuardCallback, question,  localeStrings[32], localeStrings[33])
			} else {
				alertMsg = localeStrings[21];
				showModal(0, '', getAck, alertMsg,  localeStrings[60], '')
			}
			game.hireTreasuryGuard.returnAnswer = afterAnswer;
		},
		hireTreasuryGuardCallback : function () {
			if (answer === 2) {
				if (game.gold >= config.treasuryGuardPriceHire) {
					game.treasuryGuard = game.treasuryGuard*1 + 1;
					game.gold          = game.gold - config.treasuryGuardPriceHire;
					msg = localeStrings[19];
					postEventLog(msg);
					updateResources();
				} else {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[20]);
					postEventLog(msg);
				}
			}
		},
		fireTreasuryGuard : function () {
			if (game.treasuryGuard > 0) {
				showModal(1, '', game.fireTreasuryGuardCallback, localeStrings[22],  localeStrings[32], localeStrings[33])
			} else {
				msg = localeStrings[24];
				postEventLog(msg);
			}
		},
		fireTreasuryGuardCallback : function () {
			if (answer === 2) {
				game.treasuryGuard      = game.treasuryGuard*1 - 1;
				msg = localeStrings[23];
				postEventLog(msg);
				updateResources();
			}
		},
		deathPenalty : function () {
			if (game.buildLevelGallows > 0) {
				if (game.pop > 2) {
					game.pop          = game.pop - 1;
					gold_was          = game.gold;
					gold_limit        = game.goldLimit();
					pop_limit         = game.popLimit();
					var gold_change   = Math.floor((Math.random() * game.gold)/10 * game.pop / pop_limit + 1);
					gold_possible = game.gold*1+gold_change;
					if (gold_possible > gold_limit) {
						game.gold = gold_limit;
						msg = "<b>%arg1</b>";
						msg = msg.replace("%arg1",localeStrings[3]);
						postEventLog(msg);
					} else {
						game.gold = gold_possible;
					}
					gold_incr     = game.gold - gold_was;
					rnd = Math.floor((Math.random() * 6) + 1);
					reason = localeStrings[24+rnd]
					msg = localeStrings[34].replace("%arg1", reason);
					postEventLog(msg);
					msg = localeStrings[35].replace("%arg1", gold_incr);
					postEventLog(msg);
				} else {
					alertMsg = localeStrings[36];
					showModal(0, '', getAck, alertMsg,  localeStrings[60], '')
				}
				updateResources();
			}
		},
		putOutFire : function () {
			if (game.fire === 1) {
				question = localeStrings[39].replace("%arg1", config.costPutOutFire)
				showModal(1, '', game.putOutFireCallback, question,  localeStrings[32], localeStrings[33])

			}
		},
		putOutFireCallback : function () {
			if (answer === 2) {
				if (game.gold >= config.costPutOutFire) {
					game.fire = 0;
					game.gold = game.gold - config.costPutOutFire;
					document.getElementById("fire_graphics").setAttribute("style", "position:absolute; top:200px; left:200px; z-index=100; display:none");
					document.getElementById("buttonPutOutFire").setAttribute("style", "top:390px; left: 20px; display:none");
					msg = localeStrings[40];
					postEventLog(msg);
					updateResources();
				}
				else {
					msg = localeStrings[20];
					postEventLog(msg);
				}
			} else {
				msg = localeStrings[41];
				postEventLog(msg);
			}
		},
		theftFromTreasury : function () {
			rndThieves = Math.floor(Math.random()*(game.treasuryGuard+2)+1);
			console.log(rndThieves);
			if (rndThieves === 1) {
				goldLost      = Math.floor(Math.random() * (game.gold/(1+game.buildLevelStash))+1);
				if (goldLost > game.gold) {
					goldLost = game.gold;
				}
				game.gold     = game.gold - goldLost;
				msg = localeStrings[42].replace("%arg1", goldLost);
				postEventLog(msg);
				updateResources();
			} else {
				//TODO make a message about failed robbery
			}
		},
		startFire : function () {
			if (game.fire === 0) {
				rnd = Math.floor((Math.random() * 3) + 1);
				if (rnd === 1) {
					msg = "<b>%arg1</b>";
					msg = msg.replace("%arg1",localeStrings[38]);
					postEventLog(msg);
					game.fire = 1;
					composite();
					//TODO make a certain building in fire, not just "city"
					if (game.buildLevelD == 1) {
						ceil = 1
					}
					if (game.buildLevelD == 2) {
						ceil = 2
					}
					rnd = Math.floor((Math.random() * 2) + 0);
					if (rnd === 0) {
						//	document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+fire;
					}
					if (rnd === 1) {
						//	document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+fire;
					}
					if (rnd === 0) {
						//	document.getElementById('constructions').innerHTML = document.getElementById('constructions').innerHTML+fire;
					}
				}
			} else {
				//you can't get another fire, while you do have previous still burning your city. For now.
			}
		},
		winLottery : function () {
			msg = localeStrings[43].replace("%arg1", config.lotteryPrize);
			postEventLog(msg);
			game.gold = game.gold + config.lotteryPrize;
			updateResources();
		},
		startPlague : function () {
			rnd = Math.floor((Math.random() * 5) + 1);
			if (rnd === 1) {
				if (game.pop > 2) {
					numberOfDied = Math.floor(Math.random() * (game.pop*0.65)+game.pop*0.10+1);
					if (numberOfDied>game.pop-2){
						numberOfDied = game.pop-2;
					}
					game.pop     = game.pop - numberOfDied;
					msg = localeStrings[55].replace("%arg1", numberOfDied);
					postEventLog(msg);
					updateResources();
				}
			}
		}
	};
	//init const-variables
	var config = {
		costWall:2,
		costTower:4,
		costHome:2,
		costTreasury:20,
		costGallows:50,
		costFountain:50,
		costStash:50,
		costInn:20,
		costStable:50,
		costSmith:50,
		lotteryPrize:50,
		treasuryGuardPriceHire:20,
		treasuryGuardPricePayroll:25,
		costPutOutFire:20,
		sizeMapX:9,
		sizeMapY:9,
		costHero:20,
		heroExpK:5,
		festPrice:2,
		festCooldown:30,

	}
	//init service variables
	var cnt_cursession= 0;
	var csum          = 0;
	var delimiter     = ";"
	var redraw        = 0;
	var whatDraw      = "";
	var minBL         = 0;
	var mapCreated    = 0;
	var nightMode     = 0;
	var dcounter_def  = 30;
	var dcounter      = dcounter_def;
	updateResources();
	populatePatchnotes();

	var autosaveObject;
	setupAutosave();//DEBUG
	composite();
	checkSaves();
	//init timers
	setInterval(cooldown, 1000);
	setInterval(endOfTurnTimer, 1000);
	setInterval(rndEvents, 100000);
	include('localisation.js',function(){
		loadStartLocale();
		console.log('we are in first level include after loadStartLocale()');
	});
	//functions
	function reloadHeroClassImg() {
		//just a placeholder. TODO it
	}
	popPage = 0;
	function checkPop() {
		var year = document.getElementById("popStatK");
		var pop  = document.getElementById("popStatV");
		year.innerHTML = "";
		pop.innerHTML  = "";
		popPage  = Math.round(game.years.length)/10;
		//console.log('checkPop '+popPage);
		if (game.years.length > 10) {
			//select the latest 10
			for (i=0;i<10;i++) {
				year.innerHTML = year.innerHTML +'<td>'+ game.years[game.years.length-10+i] +'</td>';
				pop.innerHTML  = pop.innerHTML  +'<td>'+ game.pops[game.years.length-10+i]  +'</td>';
				//console.log('period is '+game.years[game.years.length-10+i]+' and pop is '+game.pops[game.years.length-10+i]);
			}
			document.getElementById("lblCurrentPopLimit").innerHTML=localeStrings[80].replace("%arg1",game.popLimit());
			openTab(null, 'tabPopulation');
		} else {
			if (game.years.length > 0) 
			{
				for (i=0;i<game.years.length;i++) {
					year.innerHTML = year.innerHTML +'<td>'+ game.years[game.years.length-game.years.length+i] +'</td>';
					pop.innerHTML  = pop.innerHTML  +'<td>'+ game.pops[game.years.length-game.years.length+i]  +'</td>';
					//console.log('period is '+game.years[game.years.length-game.years.length+i]+' and pop is '+game.pops[game.years.length-game.years.length+i]);
				}
				document.getElementById("lblCurrentPopLimit").innerHTML=localeStrings[80].replace("%arg1",game.popLimit());
				openTab(null, 'tabPopulation');
			} else {
				// TODO show something!
			}
		}		
	}
	function popAtStart() { 
		var year = document.getElementById("popStatK");
		var pop  = document.getElementById("popStatV");
		year.innerHTML = "";
		pop.innerHTML  = "";
		popPage  = 0;
		//console.log('popStart '+popPage);
		if (game.years.length > 10) {
			//select the latest 10
			for (i=0;i<10;i++) {
				year.innerHTML = year.innerHTML +'<td>'+ game.years[i] +'</td>';
				pop.innerHTML  = pop.innerHTML  +'<td>'+ game.pops[i]  +'</td>';
				//console.log('period is '+game.years[i]+' and pop is '+game.pops[i]);
			}
			document.getElementById("lblCurrentPopLimit").innerHTML=localeStrings[80].replace("%arg1",game.popLimit());
			openTab(null, 'tabPopulation');
		} else {
			if (game.years.length > 0) 
			{
				for (i=0;i<game.years.length;i++) {
					year.innerHTML = year.innerHTML +'<td>'+ game.years[i] +'</td>';
					pop.innerHTML  = pop.innerHTML  +'<td>'+ game.pops[i]  +'</td>';
					//console.log('period is '+game.years[i]+' and pop is '+game.pops[i]);
				}
				document.getElementById("lblCurrentPopLimit").innerHTML=localeStrings[80].replace("%arg1",game.popLimit());
				openTab(null, 'tabPopulation');
			} else {
				// TODO show something!
			}
		}
	}
	function popPrev() {
		var year = document.getElementById("popStatK");
		var pop  = document.getElementById("popStatV");
		year.innerHTML = "";
		pop.innerHTML  = "";
		if (popPage - 1 > 0) {
			popPage  = popPage-1;
		} else {
			popPage = 0;
		}
		popPage  = Math.round(popPage*10)/10;
		//console.log('popPrev is '+popPage);
		if (game.years.length > 10) {
			//select the latest 10
			for (i=0;i<10;i++) {
				year.innerHTML = year.innerHTML +'<td>'+ game.years[popPage*10+i] +'</td>';
				pop.innerHTML  = pop.innerHTML  +'<td>'+ game.pops[popPage*10+i]  +'</td>';
				//console.log('period is '+game.years[popPage*10+i]+' and pop is '+game.pops[popPage*10+i]);
			}
			document.getElementById("lblCurrentPopLimit").innerHTML=localeStrings[80].replace("%arg1",game.popLimit());
			openTab(null, 'tabPopulation');
		} else {
			if (game.years.length > 0) 
			{
				for (i=0;i<game.years.length;i++) {
					year.innerHTML = year.innerHTML +'<td>'+ game.years[game.years.length-game.years.length+i] +'</td>';
					pop.innerHTML  = pop.innerHTML  +'<td>'+ game.pops[game.years.length-game.years.length+i]  +'</td>';
					//console.log('period is '+game.years[game.years.length-game.years.length+i]+' and pop is '+game.pops[game.years.length-game.years.length+i]);
				}
				document.getElementById("lblCurrentPopLimit").innerHTML=localeStrings[80].replace("%arg1",game.popLimit());
				openTab(null, 'tabPopulation');
			} else {
				// nothing to show
			}
		}
	}
	function popNext() {
		var year = document.getElementById("popStatK");
		var pop  = document.getElementById("popStatV");
		year.innerHTML = "";
		pop.innerHTML  = "";
		if (popPage + 1 < Math.round(game.years.length)/10-1 ) {
			popPage  = popPage+1;
		} else {
			popPage  = Math.round(game.years.length)/10-1;
		}
		popPage  = Math.round(popPage*10)/10;
		//console.log('popNext is '+popPage);
		if (game.years.length > 10) {
			//select the latest 10
			for (i=0;i<10;i++) {
				year.innerHTML = year.innerHTML +'<td>'+ game.years[popPage*10+i] +'</td>';
				pop.innerHTML  = pop.innerHTML  +'<td>'+ game.pops[popPage*10+i]  +'</td>';
				//console.log('period is '+game.years[popPage*10+i]+' and pop is '+game.pops[popPage*10+i]);
			}
			document.getElementById("lblCurrentPopLimit").innerHTML=localeStrings[80].replace("%arg1",game.popLimit());
			openTab(null, 'tabPopulation');
		} else {
			if (game.years.length > 0) 
			{
				for (i=0;i<game.years.length;i++) {
					year.innerHTML = year.innerHTML +'<td>'+ game.years[game.years.length-game.years.length+i] +'</td>';
					pop.innerHTML  = pop.innerHTML  +'<td>'+ game.pops[game.years.length-game.years.length+i]  +'</td>';
					//console.log('period is '+game.years[game.years.length-game.years.length+i]+' and pop is '+game.pops[game.years.length-game.years.length+i]);
				}
				document.getElementById("lblCurrentPopLimit").innerHTML=localeStrings[80].replace("%arg1",game.popLimit());
				openTab(null, 'tabPopulation');
			} else {
				// nothing to show
			}
		}
	}
	function popAtEnd() {
		checkPop();
	}
	goldPage = 0;
	function checkGold() {
		var year = document.getElementById("goldStatK");
		var gold = document.getElementById("goldStatV");
		year.innerHTML = "";
		gold.innerHTML  = "";
		goldPage = Math.round(game.years.length)/10;
		if (game.years.length > 10) {
			//select the latest 10
			for (i=0;i<10;i++) {
				year.innerHTML = year.innerHTML +'<td>'+ game.years[game.years.length-10+i]    +'</td>';
				gold.innerHTML = gold.innerHTML +'<td>'+ game.budgets[game.years.length-10+i]  +'</td>';
				//console.log('period is '+game.years[game.years.length-10+i]+' and gold is '+game.budgets[game.years.length-10+i]);
			}
			document.getElementById("lblCurrentGoldLimit").innerHTML=localeStrings[81].replace("%arg1",game.goldLimit());
			openTab(null, 'tabGold');
		} else {
			if (game.years.length > 0) 
			{
				for (i=0;i<game.years.length;i++) {
					year.innerHTML = year.innerHTML +'<td>'+ game.years[game.years.length-game.years.length+i]    +'</td>';
					gold.innerHTML = gold.innerHTML +'<td>'+ game.budgets[game.years.length-game.years.length+i]  +'</td>';
					//console.log('period is '+game.years[game.years.length-game.years.length+i]+' and gold is '+game.budgets[game.years.length-game.years.length+i]);
				}
				document.getElementById("lblCurrentGoldLimit").innerHTML=localeStrings[81].replace("%arg1",game.goldLimit());
				openTab(null, 'tabGold');
			} else {
				// nothing to show
			}
		}		
	}
	function goldAtStart() {
		var year = document.getElementById("goldStatK");
		var gold = document.getElementById("goldStatV");
		year.innerHTML = "";
		gold.innerHTML  = "";
		goldPage  = 0;
		if (game.years.length > 10) {
			//select the latest 10
			for (i=0;i<10;i++) {
				year.innerHTML = year.innerHTML +'<td>'+ game.years[i]    +'</td>';
				gold.innerHTML = gold.innerHTML +'<td>'+ game.budgets[i]  +'</td>';
				//console.log('period is '+game.years[i]+' and gold is '+game.budgets[i]);
			}
			document.getElementById("lblCurrentGoldLimit").innerHTML=localeStrings[81].replace("%arg1",game.goldLimit());
			openTab(null, 'tabGold');
		} else {
			if (game.years.length > 0) 
			{
				for (i=0;i<game.years.length;i++) {
					year.innerHTML = year.innerHTML +'<td>'+ game.years[i]    +'</td>';
					gold.innerHTML = gold.innerHTML +'<td>'+ game.budgets[i]  +'</td>';
					//console.log('period is '+game.years[i]+' and gold is '+game.budgets[i]);
				}
				document.getElementById("lblCurrentGoldLimit").innerHTML=localeStrings[81].replace("%arg1",game.goldLimit());
				openTab(null, 'tabGold');
			} else {
				// nothing to show
			}
		}
	}
	function goldPrev() {
		var year = document.getElementById("goldStatK");
		var gold = document.getElementById("goldStatV");
		year.innerHTML = "";
		gold.innerHTML  = "";
		if (goldPage - 1 > 0) {
			goldPage  = goldPage-1;
		} else {
			goldPage  = 0;
		}
		goldPage  = Math.round(goldPage*10)/10;
		//console.log(goldPage);
		if (game.years.length > 10) {
			//select the latest 10
			for (i=0;i<10;i++) {
				year.innerHTML = year.innerHTML +'<td>'+ game.years[goldPage*10+i]    +'</td>';
				gold.innerHTML = gold.innerHTML +'<td>'+ game.budgets[goldPage*10+i]  +'</td>';
				//console.log('period is '+game.years[goldPage*10+i]+' and gold is '+game.budgets[goldPage*10+i]);
			}
			document.getElementById("lblCurrentGoldLimit").innerHTML=localeStrings[81].replace("%arg1",game.goldLimit());
			openTab(null, 'tabGold');
		} else {
			if (game.years.length > 0) 
			{
				for (i=0;i<game.years.length;i++) {
					year.innerHTML = year.innerHTML +'<td>'+ game.years[game.years.length-game.years.length+i]    +'</td>';
					gold.innerHTML = gold.innerHTML +'<td>'+ game.budgets[game.years.length-game.years.length+i]  +'</td>';
					//console.log('period is '+game.years[game.years.length-game.years.length+i]+' and gold is '+game.budgets[game.years.length-game.years.length+i]);
				}
				document.getElementById("lblCurrentGoldLimit").innerHTML=localeStrings[81].replace("%arg1",game.goldLimit());
				openTab(null, 'tabGold');
			} else {
				// nothing to show
			}
		}
	}
	function goldNext() {
		var year = document.getElementById("goldStatK");
		var gold  = document.getElementById("goldStatV");
		year.innerHTML = "";
		gold.innerHTML  = "";
		if (goldPage + 1 < Math.round(game.years.length)/10-1 ) {
			goldPage  = goldPage+1;
		} else {
			goldPage  = Math.round(game.years.length)/10-1;
		}
		goldPage  = Math.round(goldPage*10)/10;
		//console.log(goldPage);
		if (game.years.length > 10) {
			//select the latest 10
			for (i=0;i<10;i++) {
				year.innerHTML = year.innerHTML +'<td>'+ game.years[goldPage*10+i]    +'</td>';
				gold.innerHTML = gold.innerHTML +'<td>'+ game.budgets[goldPage*10+i]  +'</td>';
				//console.log('period is '+game.years[popPage*10+i]+' and pop is '+game.budgets[goldPage*10+i]);
			}
			document.getElementById("lblCurrentGoldLimit").innerHTML=localeStrings[81].replace("%arg1",game.goldLimit());
			openTab(null, 'tabGold');
		} else {
			if (game.years.length > 0) 
			{
				for (i=0;i<game.years.length;i++) {
					year.innerHTML = year.innerHTML +'<td>'+ game.years[game.years.length-game.years.length+i]    +'</td>';
					gold.innerHTML = gold.innerHTML +'<td>'+ game.budgets[game.years.length-game.years.length+i]  +'</td>';
					//console.log('period is '+game.years[game.years.length-game.years.length+i]+' and pop is '+game.budgets[game.years.length-game.years.length+i]);
				}
				document.getElementById("lblCurrentGoldLimit").innerHTML=localeStrings[81].replace("%arg1",game.goldLimit());
				openTab(null, 'tabGold');
			} else {
				// nothing to show
			}
		}
	}
	function goldAtEnd() {
		checkGold();
	}
	function checkSaves() {
		if (localStorage.getItem('game')!==null) {
			document.getElementById("loadGameButton").style.visibility = "visible";
		}
	}
	function changeColorMode() {
		if (nightMode === 0) {
			//oldStyle= document.getElementsByTagName('body').style;
			var b = document.getElementsByTagName("body");
			//b[0].setAttribute("style",oldStyle+"background-color:black");
			b[0].style.backgroundColor = "black";
			var divs = document.getElementsByTagName("div");
			for (var i = 0; i < divs.length; i++){
				divs[i].style.color = "#404040";
			}
			var textAreas = document.getElementsByTagName("textarea");
			for (var i = 0; i < textAreas.length; i++){
				textAreas[i].style.color = "#404040";
				textAreas[i].style.backgroundColor = "black";
			}
			var buttons = document.getElementsByTagName("button");
			for (var i = 0; i < buttons.length; i++){
				buttons[i].style.color = "#606060";
				buttons[i].style.backgroundColor = "#202020";
			}
			var tab = document.getElementsByClassName("tab");
			tab[0].style.backgroundColor = "#202020";
			var inputs = document.getElementsByTagName("input");
			for (var i = 0; i < inputs.length; i++){
				inputs[i].style.color = "#606060";
				inputs[i].style.backgroundColor = "#202020";
			}
			nightMode = 1;
		} else {
			var b = document.getElementsByTagName("body");
			b[0].style.backgroundColor = "white";
			var divs = document.getElementsByTagName("div");
			for (var i = 0; i < divs.length; i++){
				divs[i].style.color = "black";
			}
			var textAreas = document.getElementsByTagName("textarea");
			for (var i = 0; i < textAreas.length; i++){
				textAreas[i].style.color = "black";
				textAreas[i].style.backgroundColor = "white";
			}
			var buttons = document.getElementsByTagName("button");
			for (var i = 0; i < buttons.length; i++){
				buttons[i].style.color = "black";
				buttons[i].style.backgroundColor = "#f1f1f1";
			}
			var tab = document.getElementsByClassName("tab");
			tab[0].style.backgroundColor = "#f1f1f1";
			var inputs = document.getElementsByTagName("input");
			for (var i = 0; i < inputs.length; i++){
				inputs[i].style.color = "black";
				inputs[i].style.backgroundColor = "white";
			}
			
			nightMode = 0;
		}
	}
	function getAck() {
		//
	}
	function reloadLang() {
		var x = document.getElementById("selectLng").selectedIndex;
		var y = document.getElementById("selectLng").options;
		language = y[x].value; //y[x].id, text, index
		loadLocale(language);
	}
	function localeCallback(returnLanguage) {
		if (returnLanguage==='en-US') {
			document.getElementById("selectLng").selectedIndex=0;
		}
		if (returnLanguage==='ru-RU') {
			document.getElementById("selectLng").selectedIndex=1;
		}
		if (returnLanguage==='de-DE') {
			document.getElementById("selectLng").selectedIndex=2;
		}
		if (returnLanguage==='eo') {
			document.getElementById("selectLng").selectedIndex=3;
		}
		if (returnLanguage==='fr-FR') {
			document.getElementById("selectLng").selectedIndex=4;
		}
		document.getElementById("buttonPutOutFire").innerText    = localeStrings[53];
		document.getElementById("buttonDeathPenalty").innerText  = localeStrings[54];
		document.getElementById("saveGameButton").innerText      = localeStrings[44];
		document.getElementById("loadGameButton").innerText      = localeStrings[45];
		document.getElementById("tabCity").innerText             = localeStrings[46];
		document.getElementById("tabExplore").innerText          = localeStrings[47];
		document.getElementById("tabSettings").innerText         = localeStrings[48];
		document.getElementById("tabGarrison").innerText         = localeStrings[49];
		document.getElementById("tabBuilding").innerText         = localeStrings[50];
		document.getElementById("tabAbout").innerText            = localeStrings[51];
		document.getElementById("tabDiscord").innerText          = localeStrings[52];
		document.getElementById("labelSettings").innerText       = localeStrings[66];
		document.getElementById("labelSettings").innerText       = localeStrings[66];
		document.getElementById("buttonExportGame").innerText    = localeStrings[67];
		document.getElementById("buttonImportGame").innerText    = localeStrings[68];
		document.getElementById("labelAutosave").innerText       = localeStrings[69];
		document.getElementById("labelGarrison").innerText       = localeStrings[91];
		document.getElementById("buttonFireGuard").innerText     = localeStrings[92];
		document.getElementById("buttonHireGuard").innerText     = localeStrings[93];
		document.getElementById("labelBuilding").innerText       = localeStrings[106];
		document.getElementById("lblAboutGame").innerHTML        = localeStrings[131].replace("%arg1",config.treasuryGuardPriceHire).replace("%arg2",config.treasuryGuardPricePayroll);
		document.getElementById("lblTabPop").innerText           = localeStrings[161];
		document.getElementById("lblTabGold").innerText          = localeStrings[171];
		document.getElementById("btnColorMode").innerText        = localeStrings[70];
		document.getElementById("lblTabInn").innerText           = localeStrings[181];
		document.getElementById("selectHeroClass")[0].text       = localeStrings[204][0];
		document.getElementById("selectHeroClass")[1].text       = localeStrings[204][1];
		welcomeMsg();
		updateButtonCaptions();
		updateHeroStatus();
	}
	function welcomeMsg(){
		postEventLog(localeStrings[0]);
		postEventLog(localeStrings[1]);
		postEventLog(localeStrings[2]);
	}
	function postEventLog(msgEventLog) {
		document.getElementById("console_n_chat").innerHTML = document.getElementById("console_n_chat").innerHTML+"<br>"+getTime(0)+": "+msgEventLog;
		scrollDown();
	}
	function postJournalLog(msgEventLog) {
		document.getElementById("lblAutocampaignJournal").innerHTML = document.getElementById("lblAutocampaignJournal").innerHTML+"<br>"+"Day "+game.myhero.aCampaignLong+": "+msgEventLog;
		scrollDown();
	}
	function generateMap() {
		//generate landscape
		game.myMapLand=[];
		for (i=0;i<config.sizeMapX;i++) {
			game.myMapLand.push([]);
		}
		for (i = 0; i < config.sizeMapX; i++) {
			for (j = 0; j < config.sizeMapY; j++) {
				//for now, all map is just green grass
				game.myMapLand[i][j] = 0; //Math.floor(Math.random()*10);
			}
		}
		//place the castle
		//castle on X axis has 3 points //144px
		//minus one because of 0..11
		//minus one for right part of the castle
		//plus  one for left  part of the castle
		//to both right and left parts could be draw on the map
		game.castleX = Math.floor(Math.random()*(config.sizeMapX-2))+1
		//castle on Y axis has 2 points // 96px
		//minus one because of 0..11
		//so  minus one for the roof of the castle
		//and plus  one for the road to the casle
		game.castleY = Math.floor(Math.random()*(config.sizeMapY-2))+1
		console.log('castleX is '+game.castleX+' and castleY is '+game.castleY);
		//castle(enter) = 10
		//castle(other) = 11
		//castle(point) = 12 //from this point we draw a castle
		//mountain      = 20
		//forest        = 1..3
		//hero          = 40
		//monster       = 50
		game.myMapObjects=[];
		for (i=0;i<config.sizeMapX;i++) {
			game.myMapObjects.push([]);
		}
		for (i = 0; i < config.sizeMapX; i++) {
			for (j = 0; j < config.sizeMapY; j++) {
				game.myMapObjects[i][j]=0;

			}
		}
		game.myMapObjects[game.castleX][game.castleY]=10;
		game.myMapObjects[game.castleX-1][game.castleY]=11;
		game.myMapObjects[game.castleX+1][game.castleY]=11;

		game.myMapObjects[game.castleX][game.castleY-1]=11;
		game.myMapObjects[game.castleX-1][game.castleY-1]=12;
		game.myMapObjects[game.castleX+1][game.castleY-1]=11;

		for (i = 0; i < config.sizeMapX; i++) {
			for (j = 0; j < config.sizeMapY; j++) {
				if (game.myMapObjects[i][j]===0) {
					rnd = Math.floor((Math.random() * 12) + 1);
					if (rnd > 3) {
						rnd = 0
					}
					game.myMapObjects[i][j]=rnd;
				}
			}
		}
		game.myMapObjects[game.castleX][game.castleY+1]=0;//just to be sure there are nothing to block path to a castle
		//RemovableObjects
		//The hero, first of all
		game.myMapRemObjects=[];
		for (i=0;i<config.sizeMapX;i++) {
			game.myMapRemObjects.push([]);
		}
		for (i = 0; i < config.sizeMapX; i++) {
			for (j = 0; j < config.sizeMapY; j++) {
				game.myMapRemObjects[i][j]=0;
			}
		}
		game.myMapRemObjects[game.castleX][game.castleY+1]=40;
		mapCreated = 1;
		composite_gm();
	}
	function populatePatchnotes() {
		msg = "version 1.0.245";
		writeToTextArea(msg);
		msg = "Now you could see what hero is doing right now";
		writeToTextArea(msg);

		msg = "version 1.0.244";
		writeToTextArea(msg);
		msg = "Added French translation";
		writeToTextArea(msg);

		msg = "version 1.0.243";
		writeToTextArea(msg);
		msg = "Made labels with current population and gold limits";
		writeToTextArea(msg);

		msg = "version 1.0.238";
		writeToTextArea(msg);
		msg = "Made onhover, onclick tips in the Buildings tab";
		writeToTextArea(msg);

		msg = "version 1.0.234";
		writeToTextArea(msg);
		msg = "Update German translation; enabled 'thieves' feature. They are now in the game!";
		writeToTextArea(msg);

		msg = "version 1.0.233";
		writeToTextArea(msg);
		msg = "Now kind ruler could place festivals!";
		writeToTextArea(msg);

		msg = "version 1.0.232";
		writeToTextArea(msg);
		msg = "There is a confirmation dialog now, when the player is about to choose kind or cruel path.";
		writeToTextArea(msg);

		msg = "version 1.0.231";
		writeToTextArea(msg);
		msg = "action required messages shown in bold font";
		writeToTextArea(msg);

		msg = "version 1.0.230";
		writeToTextArea(msg);
		msg = "Now hero stats shows as text, not as JSON. Made eventlog resizeable";
		writeToTextArea(msg);

		msg = "version 1.0.229";
		writeToTextArea(msg);
		msg = "Made Inn tab. Hero could be hired. Added alignment. Fix annoying autosave messages";
		writeToTextArea(msg);

		msg = "version 1.0.225";
		writeToTextArea(msg);
		msg = "when city on fire, there are no newborns. Also, deleted annoying cap messages";
		writeToTextArea(msg);

		msg = "version 1.0.224";
		writeToTextArea(msg);
		msg = "added Esperanto language (draft)";
		writeToTextArea(msg);

		msg = "version 1.0.223";
		writeToTextArea(msg);
		msg = "fixed bugs on stats screens";
		writeToTextArea(msg);

		msg = "version 1.0.222";
		writeToTextArea(msg);
		msg = "fixed bugs on stats screens";
		writeToTextArea(msg);

		msg = "version 1.0.219";
		writeToTextArea(msg);
		msg = "fixed imbalance of execution citizens";
		writeToTextArea(msg);

		msg = "version 1.0.217";
		writeToTextArea(msg);
		msg = "now added a screen for viewing gold statistics";
		writeToTextArea(msg);

		msg = "version 1.0.214";
		writeToTextArea(msg);
		msg = "added night mode in the game";
		writeToTextArea(msg);

		msg = "version 1.0.211";
		writeToTextArea(msg);
		msg = "now added a screen for viewing pop statistics";
		writeToTextArea(msg);

		msg = "version 1.0.207";
		writeToTextArea(msg);
		msg = "now population and gold statistics are recorded";
		writeToTextArea(msg);

		msg = "version 1.0.206";
		writeToTextArea(msg);
		msg = "now population and gold statistics are recorded";
		writeToTextArea(msg);

		msg = "version 1.0.205";
		writeToTextArea(msg);
		msg = "all objects on the city tab now is clickable";
		writeToTextArea(msg);

		msg = "version 1.0.199";
		writeToTextArea(msg);
		msg = "now the game generate the adventure map";
		writeToTextArea(msg);

		msg = "version 1.0.198";
		writeToTextArea(msg);
		msg = "done German translation";
		writeToTextArea(msg);

		msg = "version 1.0.191";
		writeToTextArea(msg);
		msg = "hiring guardsmen now done with dialogue.js";
		writeToTextArea(msg);

		msg = "version 1.0.190";
		writeToTextArea(msg);
		msg = "imported dialogue.js";
		writeToTextArea(msg);

		msg = "version 1.0.189";
		writeToTextArea(msg);
		msg = "made a language selector in Settings tab";
		writeToTextArea(msg);

		msg = "version 1.0.186";
		writeToTextArea(msg);
		msg = "made Russian translation";
		writeToTextArea(msg);

		msg = "version 1.0.180";
		writeToTextArea(msg);
		msg = "clean mess with version numeration. somewhat";
		writeToTextArea(msg);

		msg = "version 1.0.179";
		writeToTextArea(msg);
		msg = "fixed a bug with lottey. Added Discord widget. Added periods counter";
		writeToTextArea(msg);

		msg = "version 1.0.178";
		writeToTextArea(msg);
		msg = "a few minor labels\' corrections";
		writeToTextArea(msg);

		msg = "version 1.0.177";
		writeToTextArea(msg);
		msg = "fixed bug with About tab";
		writeToTextArea(msg);

		msg = "version 1.0.176";
		writeToTextArea(msg);
		msg = "due to the author\'s error, the version now is 1.0.175. Do not git push with --force!";
		writeToTextArea(msg);

		msg = "version 1.0.125";
		writeToTextArea(msg);
		msg = "fixed the bug, then player can't afford treasury upgrade and it's already full";
		writeToTextArea(msg);
		msg = "renamed About to How to Play";
		writeToTextArea(msg);

		msg = "version 1.0.124";
		writeToTextArea(msg);
		msg = "finnally, my game running by the object under the hood";
		writeToTextArea(msg);

		msg = "version 1.0.124";
		writeToTextArea(msg);
		msg = "finnaly, my game running by the object under the hood";
		writeToTextArea(msg);

		msg = "version 1.0.102";
		writeToTextArea(msg);
		msg = "added tab About game"+"\n"+
				"thus close #107";
		writeToTextArea(msg);

		msg = "version 1.0.99";
		writeToTextArea(msg);
		msg = "added Yandex Metrica"+"\n"+
				"fix #105 close #103 #70 #102 #85 #101 ";
		writeToTextArea(msg);

		msg = "version 1.0.95";
		writeToTextArea(msg);
		msg = "added Google analytics. Tuned gold limit";
		writeToTextArea(msg);

		msg = "version 1.0.94";
		writeToTextArea(msg);
		msg = "treasury limit now fixed from bug (close #80)";
		writeToTextArea(msg);

		msg = "version 1.0.93";
		writeToTextArea(msg);
		msg = "another bug with stash/treasury loading from save";
		writeToTextArea(msg);

		msg = "version 1.0.92";
		writeToTextArea(msg);
		msg = "another bug with fire in the city";
		writeToTextArea(msg);

		msg = "version 1.0.91";
		writeToTextArea(msg);
		msg = "compress resources close #73, tried singleton (hope it work), and fix #75";
		writeToTextArea(msg);

		msg = "version 1.0.89";
		writeToTextArea(msg);
		msg = "now with shiny messages in chat about execution";
		writeToTextArea(msg);

		msg = "version 1.0.88";
		writeToTextArea(msg);
		msg = "execution button";
		writeToTextArea(msg);

		msg = "version 1.0.87";
		writeToTextArea(msg);
		msg = "set build buttons invisible for Gallows-Fountain when Fountain-Gallows is built";
		writeToTextArea(msg);

		msg = "version 1.0.79";
		writeToTextArea(msg);
		msg = "gallows prevent building fountain, fountain prevent building gallows and stash requires treasury";
		writeToTextArea(msg);

		msg = "version 1.0.78";
		writeToTextArea(msg);
		msg = "bugfix #34 Autosave now implemented"+"\n"+
				"bugfix #59 new variables don't brick old saves";
		writeToTextArea(msg);

		msg = "version 1.0.76";
		writeToTextArea(msg);
		msg = "bugfix #39 Save/Load doesn't apply on fire in the city"+"\n"+
				"bugfix #42 Prevent load game if there no saves around"+"\n"+
				"bugfix #51 Save and Load with confirmation"+"\n"+
				"bugfix #54 Hiring treasury guards available only if treasury is built"+"\n"+
				"close #55 Added image of treasury guard";
		writeToTextArea(msg);

		msg = "version 1.0.72";
		writeToTextArea(msg);
		msg = "bugfix #29, #47, #48. No defence button after load"
		writeToTextArea(msg);

		msg = "version 1.0.70";
		writeToTextArea(msg);
		msg = "bugfix #44. Now it indicates if gold increased, decreased or not changed"
		writeToTextArea(msg);

		msg = "version 1.0.69";
		writeToTextArea(msg);
		msg = "bugfix #43 (word 'gold' appears after variable, when thieves stole some gold. fix #40"
		writeToTextArea(msg);

		msg = "version 1.0.68";
		writeToTextArea(msg);
		msg = "Bug fixes #35";
		writeToTextArea(msg);

		msg = "version 1.0.66";
		writeToTextArea(msg);
		msg = "You now can fire guardsmen"
		writeToTextArea(msg);

		msg = "version 1.0.65";
		writeToTextArea(msg);
		msg = "Bug fix #30. You're need to hire your treasury guards again, because save file is partially broken"
		writeToTextArea(msg);

		msg = "version 1.0.64";
		writeToTextArea(msg);
		msg = "Added new tab 'Building'. All building buttons move to 'Building' tab. Added firing procedure for treasury guardsmen (not only hiring for now). Added treasury building. As for now it does nothing, but it exists now."
		writeToTextArea(msg);
	}
	function writeToTextArea(msg) {
		document.getElementById("patchnotes").value = document.getElementById("patchnotes").value+"\r\n"+msg;
	}
	function setupAutosave() {
		game.userASaveAck = 0;
		if (game.o_autosave==0) {
			if (typeof autosaveObject !== 'undefined') {
				clearInterval(autosaveObject);
			}
			document.getElementById("autosaveImg").setAttribute("src","resources/button_red.png");
		} else {
			autosaveObject = setInterval(autosaveGame, 40000);
			document.getElementById("autosaveImg").setAttribute("src","resources/button_green.png");
		}
	}
	function changeAutosave() {
		if (game.o_autosave==0) {
			game.o_autosave = 1;
			postEventLog(localeStrings[62]);
			setupAutosave();
		} else {
			game.o_autosave = 0;
			postEventLog(localeStrings[63]);
			setupAutosave();
		}
	}
	function autosaveGame() {
		saveGame("silent");
	}
	function exportGame() {
		stringSavegame = JSON.stringify(game);
		document.getElementById("savestring").value = btoa(stringSavegame);
	}
	function importGame() {
		save64 = document.getElementById("savestring").value;
		if (save64 != null) {
			try {
				console.log("we try to load the imported save");
				saveLine  = atob(save64);
				saveArray = saveLine.split(delimiter);
				gameTemp  = JSON.parse(saveArray[0]);
				for (var propertyName in gameTemp) { game[propertyName] = gameTemp[propertyName]; }
				//options   = JSON.parse(saveArray[1]);
				var incr   = 1;
				while (game.gold === null) {
					console.log("we overwrite our gold value");
					var len    = game.budgets.length;
					game.gold  = game.budgets[len-incr];
					incr      += 1;
				}
				setupAutosave();
				composite();
				composite_gm();
				document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"\r\n"+getTime(0)+": "+localeStrings[12];
				scrollDown();
				//TODO
				//} else {
				//	alert ("save file was modified. Too bad");
				//}
			}
			catch(err) {
				console.log(err);
			}
		}
	}
	function saveGame(saveConfirmation) {
		if (saveConfirmation=="silent") {
			writeSave("silent");
		} else {
			if (localStorage.getItem('game')!==null) {
				question = localeStrings[15];
				showModal(1, '', saveGameCallback, question, localeStrings[32], localeStrings[33])
			} else {
				writeSave();
			}
		}
	}
	function saveGameCallback() {
		if (answer === 2) {
			writeSave();
		}
	}
	function writeSave(SaveType){
		document.getElementById("loadGameButton").style.visibility = "visible";
		localStorage.setItem('game', JSON.stringify(game));
		if (SaveType === "silent") {
			if (game.userASaveAck === 0) {
				game.userASaveAck = 1;
				document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"\r\n"+getTime(0)+": "+localeStrings[11];
				scrollDown();
			}
		} else {
			document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"\r\n"+getTime(0)+": "+localeStrings[11];
			scrollDown();
		}
	}
	function loadGame() {
		question = localeStrings[13];
		showModal(1, '', loadGameCallback, question,  localeStrings[32], localeStrings[33])
	}
	function loadGameCallback() {
		if (answer === 2) {
			if (localStorage.getItem('game')!==null){
				//Object.assign(game, JSON.parse(localStorage.getItem('game')));//DOESN'T WORK IN IE AT ALL.
				gameTemp = JSON.parse(localStorage.getItem('game'));
				for (var propertyName in gameTemp) { game[propertyName] = gameTemp[propertyName]; }
				//options  = JSON.parse(localStorage.getItem('options'));
				setupAutosave();
				composite();
				composite_gm();
				updateUI();
				document.getElementById("console_n_chat").value = document.getElementById("console_n_chat").value+"\r\n"+getTime(0)+": "+localeStrings[12];
				scrollDown();
			} else {
				//TODO DO NOT SHOW loadGame BUTTON UNTIL WE DO HAVE A SAVEGAME!!!!
				alert(localeStrings[14]);
			}
		}
	}
	function updateUI() {
		updateResources();
		updateTroopsNumbers();
		updateButtonCaptions();
		updateHeroStatus();
	}
	function updateButtonCaptions(){
		nextLvlHome           = game.buildLevelH*1+1;
		nextLvlPriceHome      = Math.pow(config.costHome,(game.buildLevelH*1+1));
		document.getElementById("homes").innerHTML=localeStrings[107].replace("%arg1",nextLvlHome).replace("%arg2",nextLvlPriceHome);

		nextLvlTreasury       = game.buildLevelTreasury*1+1;
		nextLvlPriceTreasury  = Math.pow(config.costTreasury,(game.buildLevelTreasury*1+1));
		document.getElementById("treasury").innerHTML=localeStrings[110].replace("%arg1",nextLvlTreasury).replace("%arg2",nextLvlPriceTreasury);

		nextLvlGallows        = game.buildLevelGallows*1+1;
		nextLvlPriceGallows   = Math.pow(config.costGallows,(game.buildLevelGallows*1+1));
		document.getElementById("buttonBldGallows").innerHTML=localeStrings[111].replace("%arg1",nextLvlGallows).replace("%arg2",nextLvlPriceGallows);

		nextLvlFountain       = game.buildLevelFountain*1+1;
		nextLvlPriceFountain  = Math.pow(config.costFountain,(game.buildLevelFountain*1+1));
		document.getElementById("buttonBldFountain").innerHTML=localeStrings[112].replace("%arg1",nextLvlFountain).replace("%arg2",nextLvlPriceFountain);

		nextLvlStash          = game.buildLevelStash*1+1;
		nextLvlPriceStash     = Math.pow(config.costStash,(game.buildLevelStash*1+1));
		document.getElementById("buttonBldStash").innerHTML=localeStrings[113].replace("%arg1",nextLvlStash).replace("%arg2",nextLvlPriceStash);

		nextLvlInn            = game.buildLevelInn*1+1;
		nextLvlPriceInn       = Math.pow(config.costInn,(game.buildLevelInn*1+1));
		document.getElementById("buttonBldInn").innerHTML=localeStrings[114].replace("%arg1",nextLvlInn).replace("%arg2",nextLvlPriceInn);

		nextLvlStable         = game.buildLevelStable*1+1;
		nextLvlPriceStable    = Math.pow(config.costStable,(game.buildLevelStable*1+1));
		document.getElementById("buttonBldStable").innerHTML=localeStrings[115].replace("%arg1",nextLvlStable).replace("%arg2",nextLvlPriceStable);
		if (game.buildLevelD == 0) {
			document.getElementById("defence").innerHTML=localeStrings[108].replace("%arg1",game.buildLevelD+1).replace("%arg2",config.costWall);
			var towerClick = "game.Build("+"\'Wall\'"+")";
			document.getElementById("defence").setAttribute("onclick", towerClick);
		}
		if (game.buildLevelD == 1) {
			document.getElementById("defence").innerHTML=localeStrings[109].replace("%arg1",game.buildLevelD+1).replace("%arg2",config.costTower);
			var towerClick = "game.Build("+"\'Tower\'"+")";
			document.getElementById("defence").setAttribute("onclick", towerClick);
		}
		if (game.buildLevelD == 2) {
			document.getElementById("defence").setAttribute("style", "display:none");
		}
		if (game.buildLevelFountain > 0) {
			document.getElementById("buttonBldGallows").setAttribute("style", "display:none");
		}
		if (game.buildLevelGallows > 0) {
			document.getElementById("buttonBldFountain").setAttribute("style", "display:none");
			document.getElementById("buttonDeathPenalty").setAttribute("style", "top:430px; left: 20px");
		}

		document.getElementById("btnHireHero").innerHTML         = localeStrings[182].replace("%arg1",game.buildLevelInn).replace("%arg2",config.costHero);
	}
	function updateHeroStatus() {
		var heroExists = (Object.keys(game.myhero).length===0 && game.myhero.constructor === Object) ? false : true;
		//console.log('heroExists value is '+heroExists.toString());
		if (heroExists === true) {
			//console.log('print status');
			var lblHeroClass    = localeStrings[204][game.myhero.class];
			var lblAlignment    = game.heroAlignment("text");
			var HTMLofHeroStats = localeStrings[205]+": "+lblHeroClass+" | ";
			var heroStatusNeedsUpdate = true;
			if (game.myhero.class==="knight"){
				game.myhero.class = 0;
			}
			if (game.myhero.class==="monk"){
				game.myhero.class = 1;
			}
			if (game.myhero.cmana === undefined){
				game.myhero.cmana = game.myhero.mana;
			}
			if (game.myhero.sergeants === undefined){
				game.myhero.sergeants = 0;
			}
			if (game.myhero.turkopols === undefined){
				game.myhero.turkopols = 0;
			}
			if (game.myhero.knights === undefined){
				game.myhero.knights = 0;
			}
			if (game.myhero.status===0){
				var rnd = Math.floor(Math.random() * localeStrings[210].length);
				console.log("in town, activity is "+rnd);
				var heroActivity = localeStrings[206]+localeStrings[210][rnd]+localeStrings[207];
				heroStatusNeedsUpdate = false;
				document.getElementById("btnAutocampaign").innerText="Launch Autocampaign!";
				document.getElementById("btnAutocampaign").style.visibility="visible";
				document.getElementById("btnAutocampaignJournal").style.visibility="visible";
				document.getElementById("trHeroHiringTroops").style.visibility="visible";
				document.getElementById("tabExplore").style.display="inline";
			}
			if (game.myhero.status===1){
				var rnd = Math.floor(Math.random() * localeStrings[211].length);
				while (rnd===0) {
					var rnd = Math.floor(Math.random() * localeStrings[211].length);
				}
				console.log("in autocampaign, activity is "+rnd);
				var heroActivity = localeStrings[206]+localeStrings[211][rnd]+localeStrings[208];
				heroStatusNeedsUpdate = false;
				document.getElementById("btnAutocampaign").innerText="Withdraw a hero";
				document.getElementById("btnAutocampaign").style.visibility="visible";
				document.getElementById("btnAutocampaignJournal").style.visibility="visible";
				document.getElementById("trHeroHiringTroops").style.visibility="collapse";
				document.getElementById("tabExplore").style.display="none";
			}
			if (game.myhero.status===2){
				var rnd = Math.floor(Math.random() * localeStrings[212].length);
				console.log("in manual ampaign, activity is "+rnd);
				var heroActivity = localeStrings[206]+localeStrings[212][rnd]+localeStrings[209];
				heroStatusNeedsUpdate = false;
				document.getElementById("btnAutocampaign").style.visibility="hidden";
				document.getElementById("btnAutocampaignJournal").style.visibility="hidden";
				document.getElementById("trHeroHiringTroops").style.visibility="collapse";
				document.getElementById("tabExplore").style.display="inline";
			}
			if (heroStatusNeedsUpdate === true) {
				game.myhero.status = 0;
			}
			HTMLofHeroStats    += localeStrings[189]+": "+game.myhero.level+"<br>";
			HTMLofHeroStats    += localeStrings[197]+": "+lblAlignment+"<br>";
			HTMLofHeroStats    += localeStrings[195]+": "+game.myhero.exp+" | ";
			HTMLofHeroStats    += localeStrings[196]+": "+game.heroNextLvlExpLimit()+"<br>";
			HTMLofHeroStats    += localeStrings[190]+": "+game.myhero.atk+" | ";
			HTMLofHeroStats    += localeStrings[191]+": "+game.myhero.def+"<br>";
			HTMLofHeroStats    += localeStrings[192]+": "+game.myhero.cmana+"/"+game.myhero.mana+" | ";
			HTMLofHeroStats    += localeStrings[193]+": "+game.myhero.mpow+"<br>";
			HTMLofHeroStats    += heroActivity+"<br>";
			HTMLofHeroStats    += "Campaign days long: "+game.myhero.aCampaignLong+"<br>";
			HTMLofHeroStats    += "Forward: "+game.myhero.aCampaignForward+" | Backward: "+game.myhero.aCampaignBackward+"<br>";
			HTMLofHeroStats    += "Gold in hero's purse"+": "+game.myhero.gold+"<br>";
			document.getElementById("heroStats").innerHTML = HTMLofHeroStats;
		} else {
			document.getElementById("heroStats").innerHTML = "";
			document.getElementById("trHeroHiringTroops").style.visibility="collapse";
		}
	}
	function updateTroopsNumbers() {
		document.getElementById("lblGarnisonSergeants").innerHTML  = game.sergeants;
		document.getElementById("lblGarnisonTurkopols").innerHTML  = game.turkopols;
		document.getElementById("lblGarnisonKnights").innerHTML    = game.knights;
		var heroExists = (Object.keys(game.myhero).length===0 && game.myhero.constructor === Object) ? false : true;
		if (heroExists === true) {
			document.getElementById("lblHeroSergeants").innerHTML = game.myhero.sergeants;
			document.getElementById("lblHeroTurkopols").innerHTML = game.myhero.turkopols;
			document.getElementById("lblHeroKnights").innerHTML = game.myhero.knights;
		}
	}
	function updateResources() {
		document.getElementById("gold").innerHTML          = game.gold;
		document.getElementById("pop").innerHTML           = game.pop;
		document.getElementById("treasuryGuard").innerHTML = game.treasuryGuard;
	}
	function getTime(type) {
		var d  = new Date();
		var hh = d.getHours();
		var mm = d.getMinutes();
		var ss = d.getSeconds();
		var n  = "";
		if (hh < 10) {
			hh = "0"+hh;
		}
		if (mm < 10) {
			mm = "0"+mm;
		}
		if (ss < 10) {
			ss = "0"+ss;
		}
		if (type=="0") {
			n = hh+":"+mm;
		}
		if (type=="1") {
			n = hh+":"+mm+":"+ss;
		}
		return n;
	}
	function scrollDown(){
		var textarea = document.getElementById("console_n_chat");
		if(textarea.selectionStart === textarea.selectionEnd) {
			textarea.scrollTop = textarea.scrollHeight;
		}
		var textarea = document.getElementById("lblAutocampaignJournal");
		if(textarea.selectionStart === textarea.selectionEnd) {
			textarea.scrollTop = textarea.scrollHeight;
		}
	}
	function updateImagesBuildingTab () {
		//TODO
	}
	function askPlayer(question, typeofasking) {
		if (typeofasking === 1) {
			playerDecision = confirm(question);
		}
		return playerDecision;
	}
	function showModal(typeofModal, dlgImage, dlgCallback, dlgMessage,  dlgAnswerOne, dlgAnswerTwo) {
		if (typeofModal===0) {
			myCanvas(dlgImage, dlgCallback, dlgMessage,  dlgAnswerOne, dlgAnswerTwo);
		}
		if (typeofModal===1) {
			myCanvas(dlgImage, dlgCallback, dlgMessage,  dlgAnswerOne, dlgAnswerTwo);
		}
		if (typeofModal===2) {
			//TODO PROMTS
		}
	}
	document.onkeyup = function(e) {
		if(e.keyCode === 38 || e.keyCode === 87) {
			game.tryHeroMovement(0,-1);//UP
		}
		if(e.keyCode === 37 || e.keyCode === 65) {
			game.tryHeroMovement(-1,0);
		}
		if(e.keyCode === 40 || e.keyCode === 83) {
			game.tryHeroMovement(0,1);//DOWN
		}
		if(e.keyCode === 68 || e.keyCode === 39) {
			game.tryHeroMovement(+1,0);//DOWN
		}
	}
	//timers
	function rndEvents() {
		var rnd = Math.floor((Math.random() * 12) + 1);
		//rnd = 2;//debug
		switch (rnd) {
			case 1:
				game.theftFromTreasury();
				break;
			case 2:
				game.startFire();
				break;
			case 3:
				game.startPlague();
				break;
			case 4:
				//
				break;
			case 5:
				//
				break;
			case 6:
				//
				break;
			case 7:
				//
				break;
			case 8:
				//
				break;
			case 9:
				//
				break;
			case 10:
				//
				break;
			case 11:
				//
				break;
			case 12:
				game.winLottery();
				break;
			default:
				alert("error on switch/case function");
		}
	}
	function endOfTurnTimer() {
		if (dcounter - 1 === 0) {
			dcounter = dcounter_def;
			game.calculateTurn();
		} else {
			dcounter = dcounter - 1;
		}
		document.getElementById('dcounter').innerText = dcounter;
	}
	function cooldown() {
		if (game.festival_cooldown-1>=0) {
			game.festival_cooldown = game.festival_cooldown-1;
		} else {
			game.festival_cooldown = 0;
		}
	}
</script>
<script>
	function openTab(evt, tabName) {
		var i, tabcontent, tablinks;
		tabcontent = document.getElementsByClassName("tabcontent");
		for (i = 0; i < tabcontent.length; i++) {
			tabcontent[i].style.display = "none";
		}
		tablinks = document.getElementsByClassName("tablinks");
		for (i = 0; i < tablinks.length; i++) {
			tablinks[i].className = tablinks[i].className.replace(" active", "");
		}
		document.getElementById(tabName).style.display = "block";
		if (evt !== null) {
			evt.currentTarget.className += " active";
		}
	}
	// Get the element with id="defaultOpen" and click on it
	document.getElementById("tabCity").click();
</script>
<script async src="dialogue.js"></script>
<!--<script src="localisation.js"></script>-->
<!--Google Analytics. Sorry guys and girls, but I need some analytic from the game. Feel free to block it -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-111661515-1"></script>
<script async>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'UA-111661515-1');
</script>
<!-- Yandex.Metrika counter. The same -->
<script type="text/javascript" >
	(function (d, w, c) {
		(w[c] = w[c] || []).push(function() {
			try {
				w.yaCounter47225574 = new Ya.Metrika({
					id:47225574,
					clickmap:true,
					trackLinks:true,
					accurateTrackBounce:true,
					webvisor:true
				});
			} catch(e) { }
		});
		var n = d.getElementsByTagName("script")[0],
				s = d.createElement("script"),
				f = function () { n.parentNode.insertBefore(s, n); };
		s.type = "text/javascript";
		s.async = true;
		s.src = "https://mc.yandex.ru/metrika/watch.js";
		if (w.opera == "[object Opera]") {
			d.addEventListener("DOMContentLoaded", f, false);
		} else { f(); }
	})(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/47225574" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
</body>
</html>
